<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>코딩스타트: 블록 코딩 환경</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/blockly_compressed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/blocks_compressed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/javascript_compressed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/python_compressed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/msg/ko.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            margin: 0 auto;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }

        .header {
            height: 60px;
            background: linear-gradient(135deg, #4285f4, #2a5298);
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-title {
            color: white;
            font-weight: bold;
            font-size: 22px;
            margin-right: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-title:hover {
            transform: scale(1.05);
        }

        .project-name {
            height: 30px;
            width: 200px;
            border-radius: 5px;
            border: none;
            padding: 0 10px;
            margin-right: 20px;
        }

        .header-button {
            height: 30px;
            padding: 0 15px;
            border-radius: 15px;
            border: none;
            background-color: rgba(255,255,255,0.2);
            color: white;
            font-size: 14px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-button:hover {
            background-color: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .back-button {
            background-color: rgba(255,255,255,0.1);
            margin-right: auto;
        }

        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .category-tabs {
            height: 40px;
            background-color: #eee;
            display: flex;
            align-items: center;
            padding: 0 10px;
        }

        .category-tab {
            width: 40px;
            height: 30px;
            border-radius: 5px;
            margin-right: 10px;
            border: none;
            cursor: pointer;
        }

        .search-block {
            margin: 10px;
            position: relative;
        }

        .search-input {
            width: 100%;
            height: 30px;
            border-radius: 15px;
            border: 1px solid #ddd;
            padding: 0 15px;
            font-size: 12px;
        }

        .category-title {
            height: 30px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-weight: bold;
            color: white;
            font-size: 14px;
        }

        .blocks-container {
            overflow-y: auto;
            flex: 1;
        }

        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .workspace-controls {
            height: 40px;
            background-color: #eee;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        .workspace-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .minimap {
            width: 100px;
            height: 30px;
            background-color: #f1f3f4;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
        }

        #blocklyDiv {
            flex: 1;
            border-top: 1px solid #ddd;
        }

        .status-bar {
            height: 30px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #ddd;
        }

        .right-panel {
            width: 280px;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .result-header {
            height: 40px;
            background-color: #eee;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        .result-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .control-buttons {
            display: flex;
        }

        .control-button {
            width: 30px;
            height: 30px;
            border-radius: 15px;
            border: none;
            margin-left: 10px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            transform: scale(1.1);
        }

        .run-button {
            background-color: #4285f4;
        }

        .stop-button {
            background-color: #fbbc05;
        }

        .reset-button {
            background-color: #34a853;
        }

        .result-canvas {
            height: 260px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            margin: 10px;
            position: relative;
        }

        .character {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid #3b78e7;
            transform-origin: 50% 50%;
        }

        .console {
            height: 150px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            margin: 10px;
            padding: 10px;
            overflow-y: auto;
            font-size: 12px;
        }

        .console-line {
            margin: 5px 0;
        }

        .variable-monitor {
            flex: 1;
            background-color: #fff;
            border: 1px solid #ddd;
            margin: 10px;
            padding: 10px;
            overflow-y: auto;
        }

        .variable-monitor-title {
            font-weight: bold;
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
        }

        .variable-item {
            height: 30px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            padding: 0 15px;
            display: flex;
            align-items: center;
            font-size: 12px;
        }

        .code-panel {
            height: 260px;
            background-color: #292d3e;
            border: 1px solid #1e2132;
            display: flex;
            flex-direction: column;
        }

        .code-header {
            height: 40px;
            background-color: #1e2132;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        .code-title {
            font-weight: bold;
            font-size: 16px;
            color: white;
        }

        .language-buttons {
            display: flex;
        }

        .language-button {
            width: 80px;
            height: 30px;
            border-radius: 5px;
            margin-left: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .active-language {
            background-color: #3b78e7;
            border: none;
        }

        .inactive-language {
            background-color: #292d3e;
            border: 1px solid #3b78e7;
        }

        .inactive-language:hover {
            background-color: #3b78e7;
        }

        .code-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            color: #a6accd;
            font-family: Consolas, monospace;
            font-size: 14px;
            white-space: pre;
        }

        .code-tip {
            height: 30px;
            background-color: #333652;
            border: 1px solid #23293e;
            margin: 0 20px 20px;
            border-radius: 5px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #a6accd;
        }

        .category-control {
            background-color: #fbbc05;
        }

        .category-movement {
            background-color: #4285f4;
        }

        .category-variables {
            background-color: #ea4335;
        }

        .category-logic {
            background-color: #34a853;
        }

        /* 통합 네비게이션 스타일 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .navigation-notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
    </style>
</head>

<body>
    <!-- 로딩 오버레이 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="main-container">
        <div class="header">
            <div class="header-title" id="logoTitle">🚀 코딩스타트: 블록 코딩</div>
            <button class="header-button back-button" id="backButton">← 대시보드</button>
            <input type="text" class="project-name" value="내 프로젝트">
            <div style="flex-grow: 1;"></div>
            <button class="header-button" id="runButton">실행</button>
            <button class="header-button" id="saveButton">저장</button>
            <button class="header-button" id="loadButton">불러오기</button>
        </div>
        <div class="content">
            <div class="left-panel">
                <div id="toolbox" style="display: none;">
                    <xml id="toolboxXML">
                        <category name="제어" colour="#fbbc05">
                            <block type="start"></block>
                            <block type="controls_repeat_ext">
                                <value name="TIMES">
                                    <shadow type="math_number">
                                        <field name="NUM">10</field>
                                    </shadow>
                                </value>
                            </block>
                            <block type="controls_if"></block>
                            <block type="wait">
                                <value name="TIME">
                                    <shadow type="math_number">
                                        <field name="NUM">1</field>
                                    </shadow>
                                </value>
                            </block>
                        </category>
                        <category name="움직임" colour="#4285f4">
                            <block type="move_forward">
                                <value name="DISTANCE">
                                    <shadow type="math_number">
                                        <field name="NUM">10</field>
                                    </shadow>
                                </value>
                            </block>
                            <block type="turn_right">
                                <value name="ANGLE">
                                    <shadow type="math_number">
                                        <field name="NUM">90</field>
                                    </shadow>
                                </value>
                            </block>
                            <block type="turn_left">
                                <value name="ANGLE">
                                    <shadow type="math_number">
                                        <field name="NUM">90</field>
                                    </shadow>
                                </value>
                            </block>
                        </category>
                        <category name="논리" colour="#34a853">
                            <block type="logic_compare"></block>
                            <block type="logic_operation"></block>
                            <block type="logic_boolean"></block>
                        </category>
                        <category name="변수" colour="#ea4335" custom="VARIABLE"></category>
                        <category name="수학" colour="#9966FF">
                            <block type="math_number">
                                <field name="NUM">1</field>
                            </block>
                            <block type="math_arithmetic">
                                <value name="A">
                                    <shadow type="math_number">
                                        <field name="NUM">1</field>
                                    </shadow>
                                </value>
                                <value name="B">
                                    <shadow type="math_number">
                                        <field name="NUM">1</field>
                                    </shadow>
                                </value>
                            </block>
                            <block type="math_number_property">
                                <value name="NUMBER_TO_CHECK">
                                    <shadow type="math_number">
                                        <field name="NUM">0</field>
                                    </shadow>
                                </value>
                            </block>
                        </category>
                    </xml>
                </div>
                <div id="blocklyToolbox"></div>
            </div>
            <div class="center-panel">
                <div class="workspace-controls">
                    <div class="workspace-title">코드 작성 영역</div>
                    <div class="minimap">미니맵</div>
                </div>
                <div id="blocklyDiv"></div>
                <div class="status-bar">
                    <span id="blockCount">블록 수: 0</span> | <span id="lastSaved">마지막 저장: --:-- --</span>
                </div>
            </div>
            <div class="right-panel">
                <div class="result-header">
                    <div class="result-title">실행 결과</div>
                    <div class="control-buttons">
                        <button class="control-button run-button" id="runButtonSmall">▶</button>
                        <button class="control-button stop-button" id="stopButton">■</button>
                        <button class="control-button reset-button" id="resetButton">↻</button>
                    </div>
                </div>
                <div class="result-canvas" id="canvas">
                    <div class="character" id="character" style="left: 130px; top: 130px; transform: rotate(0deg);">
                    </div>
                </div>
                <div class="console" id="console">
                    <div class="console-line">> 프로그램 시작</div>
                </div>
                <div class="variable-monitor">
                    <div class="variable-monitor-title">변수 모니터</div>
                    <div id="variables"></div>
                </div>
            </div>
        </div>
        <div class="code-panel">
            <div class="code-header">
                <div class="code-title">실제 코드 (Python)</div>
                <div class="language-buttons">
                    <div class="language-button active-language" id="pythonButton">Python</div>
                    <div class="language-button inactive-language" id="javascriptButton">JavaScript</div>
                    <div class="language-button inactive-language" id="cppButton">C++</div>
                </div>
            </div>
            <div class="code-content" id="codeContent"></div>
        </div>
    </div>

    <script>
        // 통합 네비게이션 시스템
        class NavigationManager {
            constructor() {
                this.currentUser = null;
                this.routes = {
                    'dashboard': '/dashboard',
                    'block-coding': '/block-coding', 
                    'algorithm': '/algorithm',
                    'assignments': '/assignments',
                    'progress': '/progress',
                    'teacher-dashboard': '/teacher-dashboard',
                    'create-assignment': '/create-assignment',
                    'review-submissions': '/review-submissions',
                    'student-analytics': '/student-analytics',
                    'student-management': '/student-management',
                    'login': '/login'
                };
                
                this.init();
            }

            init() {
                this.loadUserInfo();
                this.setupEventListeners();
            }

            loadUserInfo() {
                const token = localStorage.getItem('authToken');
                const userJSON = localStorage.getItem('user');

                if (!token || !userJSON) {
                    this.redirectToLogin();
                    return false;
                }

                try {
                    this.currentUser = JSON.parse(userJSON);
                    return true;
                } catch (error) {
                    console.error('사용자 정보 파싱 오류:', error);
                    this.clearAuthAndRedirect();
                    return false;
                }
            }

            setupEventListeners() {
                // 로고/타이틀 클릭 이벤트
                const logoTitle = document.getElementById('logoTitle');
                if (logoTitle) {
                    logoTitle.addEventListener('click', () => {
                        this.navigateToDashboard();
                    });
                }

                // 뒤로가기 버튼
                const backButton = document.getElementById('backButton');
                if (backButton) {
                    backButton.addEventListener('click', () => {
                        this.navigateToDashboard();
                    });
                }
            }

            navigateToDashboard() {
                if (this.currentUser.role === 'professor' || this.currentUser.role === 'admin') {
                    this.navigateTo('teacher-dashboard');
                } else {
                    this.navigateTo('dashboard');
                }
            }

            navigateTo(routeName) {
                if (this.routes[routeName]) {
                    this.showLoading();
                    
                    setTimeout(() => {
                        window.location.href = this.routes[routeName];
                    }, 300);
                } else {
                    console.error(`Route not found: ${routeName}`);
                }
            }

            redirectToLogin() {
                this.showNotification('로그인이 필요합니다.', 'error');
                setTimeout(() => {
                    window.location.href = this.routes.login;
                }, 1500);
            }

            clearAuthAndRedirect() {
                localStorage.clear();
                this.redirectToLogin();
            }

            showLoading() {
                let loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('active');
                }
            }

            hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.remove('active');
                }
            }

            showNotification(message, type = 'success') {
                const existingNotification = document.getElementById('navigationNotification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                const notification = document.createElement('div');
                notification.id = 'navigationNotification';
                notification.className = 'navigation-notification';
                notification.textContent = message;

                const backgroundColor = type === 'error' 
                    ? 'linear-gradient(135deg, #f44336, #d32f2f)' 
                    : 'linear-gradient(135deg, #4CAF50, #45a049)';

                notification.style.background = backgroundColor;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);

                setTimeout(() => {
                    notification.style.transform = 'translateX(400px)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        }

        // 네비게이션 매니저 초기화
        let navigationManager;

        // Blockly 초기화 및 기존 블록 코딩 로직
        document.addEventListener('DOMContentLoaded', function () {
            // 네비게이션 매니저 초기화
            navigationManager = new NavigationManager();

            // 커스텀 블록 정의
            Blockly.Blocks['start'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("시작하기");
                    this.setNextStatement(true, null);
                    this.setColour(240);
                    this.setTooltip("프로그램이 시작될 때 실행됩니다.");
                    this.setHelpUrl("");
                }
            };

            Blockly.Blocks['move_forward'] = {
                init: function () {
                    this.appendValueInput("DISTANCE")
                        .setCheck("Number")
                        .appendField("앞으로 이동");
                    this.appendDummyInput()
                        .appendField("만큼");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(210);
                    this.setTooltip("캐릭터를 앞으로 이동시킵니다.");
                    this.setHelpUrl("");
                }
            };

            Blockly.Blocks['turn_right'] = {
                init: function () {
                    this.appendValueInput("ANGLE")
                        .setCheck("Number")
                        .appendField("오른쪽으로");
                    this.appendDummyInput()
                        .appendField("도");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(210);
                    this.setTooltip("캐릭터를 오른쪽으로 회전시킵니다.");
                    this.setHelpUrl("");
                }
            };

            Blockly.Blocks['turn_left'] = {
                init: function () {
                    this.appendValueInput("ANGLE")
                        .setCheck("Number")
                        .appendField("왼쪽으로");
                    this.appendDummyInput()
                        .appendField("도");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(210);
                    this.setTooltip("캐릭터를 왼쪽으로 회전시킵니다.");
                    this.setHelpUrl("");
                }
            };

            Blockly.Blocks['wait'] = {
                init: function () {
                    this.appendValueInput("TIME")
                        .setCheck("Number")
                        .appendField("기다리기");
                    this.appendDummyInput()
                        .appendField("초");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(240);
                    this.setTooltip("지정된 시간(초) 동안 기다립니다.");
                    this.setHelpUrl("");
                }
            };

            // JavaScript 코드 생성기
            Blockly.JavaScript['start'] = function (block) {
                return '// 프로그램 시작\n';
            };

            Blockly.JavaScript['move_forward'] = function (block) {
                var value_distance = Blockly.JavaScript.valueToCode(block, 'DISTANCE', Blockly.JavaScript.ORDER_ATOMIC);
                var code = 'await moveForward(' + value_distance + ');\n';
                return code;
            };

            Blockly.JavaScript['turn_right'] = function (block) {
                var value_angle = Blockly.JavaScript.valueToCode(block, 'ANGLE', Blockly.JavaScript.ORDER_ATOMIC);
                var code = 'await turnRight(' + value_angle + ');\n';
                return code;
            };

            Blockly.JavaScript['turn_left'] = function (block) {
                var value_angle = Blockly.JavaScript.valueToCode(block, 'ANGLE', Blockly.JavaScript.ORDER_ATOMIC);
                var code = 'await turnLeft(' + value_angle + ');\n';
                return code;
            };

            Blockly.JavaScript['wait'] = function (block) {
                var value_time = Blockly.JavaScript.valueToCode(block, 'TIME', Blockly.JavaScript.ORDER_ATOMIC);
                var code = 'await sleep(' + value_time + ');\n';
                return code;
            };

            // JavaScript 변수 관련 코드 생성기 수정
            Blockly.JavaScript['variables_set'] = function(block) {
                var argument0 = Blockly.JavaScript.valueToCode(block, 'VALUE',
                    Blockly.JavaScript.ORDER_ASSIGNMENT) || '0';
                var varId = block.getFieldValue('VAR');
                var varName = block.workspace.getVariableById(varId).name;
                
                return 'updateVariable("' + varName + '", ' + argument0 + ');\n';
            };

            Blockly.JavaScript['math_change'] = function(block) {
                var argument0 = Blockly.JavaScript.valueToCode(block, 'DELTA',
                    Blockly.JavaScript.ORDER_ADDITION) || '0';
                var varId = block.getFieldValue('VAR');
                var varName = block.workspace.getVariableById(varId).name;
                
                return 'updateVariable("' + varName + '", ' + 
                    'variables["' + varName + '"] + ' + argument0 + ');\n';
            };

            // 변수 가져오기 함수 수정
            Blockly.JavaScript['variables_get'] = function(block) {
                var varId = block.getFieldValue('VAR');
                var varName = block.workspace.getVariableById(varId).name;
                
                return ['variables["' + varName + '"]', Blockly.JavaScript.ORDER_ATOMIC];
            };

            // Python 코드 생성기들도 동일하게 유지...
            // (기존 Python 코드 생성기들 생략 - 원본과 동일)

            // 작업 공간 초기화
            var workspace = Blockly.inject('blocklyDiv', {
                toolbox: document.getElementById('toolboxXML'),
                grid: {
                    spacing: 20,
                    length: 3,
                    colour: '#ccc',
                    snap: true
                },
                zoom: {
                    controls: true,
                    wheel: true,
                    startScale: 1.0,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                trashcan: true
            });

            // Python 코드 생성기
            Blockly.Python['start'] = function (block) {
                return '# 프로그램 시작\n';
            };

            Blockly.Python['move_forward'] = function (block) {
                var value_distance = Blockly.Python.valueToCode(block, 'DISTANCE', Blockly.Python.ORDER_ATOMIC);
                var code = 'move_forward(' + value_distance + ')\n';
                return code;
            };

            Blockly.Python['turn_right'] = function (block) {
                var value_angle = Blockly.Python.valueToCode(block, 'ANGLE', Blockly.Python.ORDER_ATOMIC);
                var code = 'turn_right(' + value_angle + ')\n';
                return code;
            };

            Blockly.Python['turn_left'] = function (block) {
                var value_angle = Blockly.Python.valueToCode(block, 'ANGLE', Blockly.Python.ORDER_ATOMIC);
                var code = 'turn_left(' + value_angle + ')\n';
                return code;
            };

            Blockly.Python['wait'] = function (block) {
                var value_time = Blockly.Python.valueToCode(block, 'TIME', Blockly.Python.ORDER_ATOMIC);
                var code = 'wait(' + value_time + ')\n';
                return code;
            };

            // Python 변수 관련 코드 생성기
            Blockly.Python['variables_set'] = function(block) {
                var argument0 = Blockly.Python.valueToCode(block, 'VALUE',
                    Blockly.Python.ORDER_ASSIGNMENT) || '0';
                var varId = block.getFieldValue('VAR');
                var varName = block.workspace.getVariableById(varId).name;
                
                return varName + ' = ' + argument0 + '\n';
            };

            Blockly.Python['variables_get'] = function(block) {
                var varId = block.getFieldValue('VAR');
                var varName = block.workspace.getVariableById(varId).name;
                
                return [varName, Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['math_change'] = function(block) {
                var argument0 = Blockly.Python.valueToCode(block, 'DELTA',
                    Blockly.Python.ORDER_ADDITIVE) || '0';
                var varId = block.getFieldValue('VAR');
                var varName = block.workspace.getVariableById(varId).name;
                
                return varName + ' += ' + argument0 + '\n';
            };

            // 블록 변경 이벤트 감지
            workspace.addChangeListener(function (event) {
                if (event.type == Blockly.Events.BLOCK_CREATE ||
                    event.type == Blockly.Events.BLOCK_DELETE ||
                    event.type == Blockly.Events.BLOCK_CHANGE ||
                    event.type == Blockly.Events.BLOCK_MOVE ||
                    event.type == Blockly.Events.VAR_CREATE ||
                    event.type == Blockly.Events.VAR_DELETE ||
                    event.type == Blockly.Events.VAR_RENAME) {

                    updateCode();
                    updateBlockCount();

                    if (event.type == Blockly.Events.VAR_CREATE ||
                        event.type == Blockly.Events.VAR_RENAME) {
                        let variableList = workspace.getAllVariables();
                        for (let i = 0; i < variableList.length; i++) {
                            let varName = variableList[i].name;
                            if (!(varName in variables)) {
                                updateVariable(varName, 0);
                            }
                        }
                    }
                }
            });

            // 코드 생성 및 업데이트
            function updateCode() {
                var pythonCode = '';
                
                try {
                    pythonCode = Blockly.Python.workspaceToCode(workspace);
                    
                    var variableList = workspace.getAllVariables();
                    var variableDeclarations = '';
                    
                    if (variableList.length > 0) {
                        variableDeclarations = '# 전역 변수 선언\n';
                        if (variableList.length > 0) {
                            variableDeclarations += 'global ' + variableList.map(v => v.name).join(', ') + '\n';
                        }
                    }
                    
                    var formattedPythonCode = '# 생성된 Python 코드\n' +
                        'def main():\n' +
                        (variableDeclarations ? '    ' + variableDeclarations.replace(/\n/g, '\n    ') : '') +
                        '    # 프로그램 시작\n' +
                        (variableList.length > 0 ? '    ' + variableList.map(v => v.name + ' = 0').join('\n    ') + '\n' : '') +
                        pythonCode.split('\n').map(line => line ? '    ' + line : '').join('\n') +
                        '\n\n' +
                        'if __name__ == "__main__":\n' +
                        '    main()';
                    
                    pythonCode = formattedPythonCode;
                } catch (e) {
                    console.error('Python 코드 생성 오류:', e);
                    pythonCode = '# Python 코드 생성 중 오류가 발생했습니다.\n# ' + e.message;
                }

                var jsCode = '';
                
                try {
                    jsCode = Blockly.JavaScript.workspaceToCode(workspace);
                    
                    var variableList = workspace.getAllVariables();
                    var variableInitializations = '';
                    
                    for (var i = 0; i < variableList.length; i++) {
                        variableInitializations += ' updateVariable("' + variableList[i].name + '", 0);\n';
                    }
                    
                    jsCode = '// 생성된 JavaScript 코드\n' +
                        'async function main() {\n' +
                        variableInitializations +
                        jsCode.split('\n').map(line => line ? ' ' + line : '').join('\n') +
                        '\n}\n\n' +
                        'main();';
                } catch (e) {
                    console.error('JavaScript 코드 생성 오류:', e);
                    jsCode = '// JavaScript 코드 생성 중 오류가 발생했습니다.\n// ' + e.message;
                }

                var cppCode = generateCppCode(workspace);

                var activeLanguage = document.querySelector('.language-button.active-language').id;
                if (activeLanguage === 'pythonButton') {
                    document.getElementById('codeContent').textContent = pythonCode;
                } else if (activeLanguage === 'javascriptButton') {
                    document.getElementById('codeContent').textContent = jsCode;
                } else if (activeLanguage === 'cppButton') {
                    document.getElementById('codeContent').textContent = cppCode;
                }
            }

            // C++ 코드 생성 함수
            function generateCppCode(workspace) {
                var variableList = workspace.getAllVariables();
                var variableDeclarations = '';
                
                for (var i = 0; i < variableList.length; i++) {
                    variableDeclarations += 'int ' + variableList[i].name + ' = 0;\n';
                }
                
                return '// 생성된 C++ 코드\n' +
                    '#include <iostream>\n' +
                    '#include <chrono>\n' +
                    '#include <thread>\n\n' +
                    variableDeclarations + '\n' +
                    'void move_forward(int distance) {\n' +
                    '    std::cout << "앞으로 " << distance << "만큼 이동" << std::endl;\n' +
                    '}\n\n' +
                    'void turn_right(int angle) {\n' +
                    '    std::cout << "오른쪽으로 " << angle << "도 회전" << std::endl;\n' +
                    '}\n\n' +
                    'void turn_left(int angle) {\n' +
                    '    std::cout << "왼쪽으로 " << angle << "도 회전" << std::endl;\n' +
                    '}\n\n' +
                    'void wait(int seconds) {\n' +
                    '    std::this_thread::sleep_for(std::chrono::seconds(seconds));\n' +
                    '}\n\n' +
                    'int main() {\n' +
                    '    // 여기에 생성된 코드가 들어갑니다\n' +
                    '    move_forward(10);\n' +
                    '    for (int i = 0; i < 4; i++) {\n' +
                    '        turn_right(90);\n' +
                    '        move_forward(10);\n' +
                    '    }\n' +
                    '    wait(1);\n' +
                    '    return 0;\n' +
                    '}';
            }

            // 블록 개수 업데이트
            function updateBlockCount() {
                var count = workspace.getAllBlocks(false).length;
                document.getElementById('blockCount').textContent = '블록 수: ' + count;
            }

            // 기본 코드 로드 (샘플)
            function loadSampleProgram() {
                var xml = `
<xml xmlns="https://developers.google.com/blockly/xml">
<block type="start" id="start_block" x="300" y="150">
<next>
<block type="variables_set" id="set_score">
<field name="VAR">점수</field>
<value name="VALUE">
<block type="math_number">
<field name="NUM">0</field>
</block>
</value>
<next>
<block type="move_forward">
<value name="DISTANCE">
<shadow type="math_number">
<field name="NUM">10</field>
</shadow>
</value>
<next>
<block type="controls_repeat_ext">
<value name="TIMES">
<shadow type="math_number">
<field name="NUM">4</field>
</shadow>
</value>
<statement name="DO">
<block type="turn_right">
<value name="ANGLE">
<shadow type="math_number">
<field name="NUM">90</field>
</shadow>
</value>
<next>
<block type="move_forward">
<value name="DISTANCE">
<shadow type="math_number">
<field name="NUM">10</field>
</shadow>
</value>
<next>
<block type="math_change">
<field name="VAR">점수</field>
<value name="DELTA">
<shadow type="math_number">
<field name="NUM">1</field>
</shadow>
</value>
<next>
<block type="wait">
<value name="TIME">
<shadow type="math_number">
<field name="NUM">1</field>
</shadow>
</value>
</block>
</next>
</block>
</next>
</block>
</next>
</block>
</statement>
</block>
</next>
</block>
</next>
</block>
</next>
</block>
</xml>
`;
                Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(xml), workspace);
                updateCode();
                updateBlockCount();
            }

            // 캐릭터 위치와 방향 설정을 위한 변수
            var character = document.getElementById('character');
            var x = 130;
            var y = 130;
            var angle = 0;
            var variables = {};
            var isRunning = false;
            var shouldStop = false;

            // 콘솔에 메시지 추가
            function logToConsole(message) {
                var console = document.getElementById('console');
                var line = document.createElement('div');
                line.className = 'console-line';
                line.textContent = '> ' + message;
                console.appendChild(line);
                console.scrollTop = console.scrollHeight;
            }

            // 변수 업데이트 함수
            function updateVariable(name, value) {
                if (!isNaN(Number(value)) && value !== '') {
                    value = Number(value);
                }
                
                variables[name] = value;
                logToConsole(`변수 ${name}의 값이 ${value}로 변경되었습니다.`);
                updateVariableDisplay();
            }

            // 변수 표시 업데이트
            function updateVariableDisplay() {
                var variablesDiv = document.getElementById('variables');
                variablesDiv.innerHTML = '';

                for (var name in variables) {
                    var item = document.createElement('div');
                    item.className = 'variable-item';
                    item.textContent = name + ': ' + variables[name];
                    variablesDiv.appendChild(item);
                }

                var posX = document.createElement('div');
                posX.className = 'variable-item';
                posX.textContent = '위치X: ' + Math.round(x);
                variablesDiv.appendChild(posX);

                var posY = document.createElement('div');
                posY.className = 'variable-item';
                posY.textContent = '위치Y: ' + Math.round(y);
                variablesDiv.appendChild(posY);
            }

            // 캐릭터 상태 초기화
            function resetCharacter() {
                x = 130;
                y = 130;
                angle = 0;
                character.style.left = x + 'px';
                character.style.top = y + 'px';
                character.style.transform = 'rotate(' + angle + 'deg)';

                document.getElementById('console').innerHTML = '<div class="console-line">> 프로그램 시작</div>';
                variables = {};
                updateVariableDisplay();
            }

            // 움직임 함수
            async function moveForward(distance) {
                logToConsole('앞으로 ' + distance + '만큼 이동');

                var radians = angle * Math.PI / 180;
                var targetX = x + Math.sin(radians) * distance;
                var targetY = y - Math.cos(radians) * distance;

                var steps = 20;
                var deltaX = (targetX - x) / steps;
                var deltaY = (targetY - y) / steps;

                for (var i = 0; i < steps; i++) {
                    if (shouldStop) return;
                    x += deltaX;
                    y += deltaY;
                    character.style.left = x + 'px';
                    character.style.top = y + 'px';
                    updateVariableDisplay();
                    await sleep(0.05);
                }

                x = targetX;
                y = targetY;
                character.style.left = x + 'px';
                character.style.top = y + 'px';
                updateVariableDisplay();
            }

            // 회전 함수 (오른쪽)
            async function turnRight(degrees) {
                logToConsole('오른쪽으로 ' + degrees + '도 회전');

                var targetAngle = angle + degrees;
                var steps = 10;
                var deltaAngle = degrees / steps;

                for (var i = 0; i < steps; i++) {
                    if (shouldStop) return;
                    angle += deltaAngle;
                    character.style.transform = 'rotate(' + angle + 'deg)';
                    await sleep(0.05);
                }

                angle = targetAngle;
                character.style.transform = 'rotate(' + angle + 'deg)';
            }

            // 회전 함수 (왼쪽)
            async function turnLeft(degrees) {
                logToConsole('왼쪽으로 ' + degrees + '도 회전');

                var targetAngle = angle - degrees;
                var steps = 10;
                var deltaAngle = degrees / steps;

                for (var i = 0; i < steps; i++) {
                    if (shouldStop) return;
                    angle -= deltaAngle;
                    character.style.transform = 'rotate(' + angle + 'deg)';
                    await sleep(0.05);
                }

                angle = targetAngle;
                character.style.transform = 'rotate(' + angle + 'deg)';
            }

            // 지연 함수
            function sleep(seconds) {
                const ms = seconds * 1000;
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // 코드 실행 함수
            async function runCode() {
                if (isRunning) return;

                isRunning = true;
                shouldStop = false;
                resetCharacter();
                logToConsole('프로그램 실행 시작');

                try {
                    let variableList = workspace.getAllVariables();
                    for (let i = 0; i < variableList.length; i++) {
                        let varName = variableList[i].name;
                        variables[varName] = 0;
                        updateVariableDisplay();
                    }
                    
                    var code = Blockly.JavaScript.workspaceToCode(workspace);
                    
                    code = `async function runUserCode() {
                        try {
                            ${code}
                        } catch (e) {
                            console.error("Error in user code:", e);
                            throw e;
                        }
                    }
                    runUserCode();`;

                    var runFunction = new Function(
                        'moveForward', 'turnRight', 'turnLeft', 
                        'sleep', 'updateVariable', 'variables',
                        code
                    );

                    await runFunction(
                        moveForward, turnRight, turnLeft, 
                        sleep, updateVariable, variables
                    );

                    if (!shouldStop) {
                        logToConsole('프로그램 실행 완료');
                    }
                } catch (e) {
                    logToConsole('오류 발생: ' + e.message);
                    console.error(e);
                }

                isRunning = false;
            }

            // 코드 실행 중지 함수
            function stopCode() {
                if (!isRunning) return;
                shouldStop = true;
                logToConsole('프로그램 실행 중지');
            }

            // 저장 기능
            function saveProgram() {
                var xml = Blockly.Xml.workspaceToDom(workspace);
                var xmlText = Blockly.Xml.domToText(xml);
                localStorage.setItem('savedProgram', xmlText);

                var now = new Date();
                var timeString = now.getHours().toString().padStart(2, '0') + ':' +
                    now.getMinutes().toString().padStart(2, '0') + ' ' +
                    (now.getHours() >= 12 ? 'PM' : 'AM');
                document.getElementById('lastSaved').textContent = '마지막 저장: ' + timeString;

                logToConsole('프로그램이 저장되었습니다.');
                
                // 네비게이션 매니저의 알림 시스템 사용
                if (navigationManager) {
                    navigationManager.showNotification('프로젝트가 저장되었습니다!');
                }
            }

            // 로드 기능
            function loadProgram() {
                var savedProgram = localStorage.getItem('savedProgram');
                if (savedProgram) {
                    workspace.clear();
                    var xml = Blockly.Xml.textToDom(savedProgram);
                    Blockly.Xml.domToWorkspace(xml, workspace);
                    updateCode();
                    updateBlockCount();
                    logToConsole('저장된 프로그램을 불러왔습니다.');
                    
                    if (navigationManager) {
                        navigationManager.showNotification('프로젝트를 불러왔습니다!');
                    }
                } else {
                    logToConsole('저장된 프로그램이 없습니다.');
                    
                    if (navigationManager) {
                        navigationManager.showNotification('저장된 프로젝트가 없습니다.', 'error');
                    }
                }
            }

            // 언어 전환 기능
            function switchLanguage(language) {
                var pythonButton = document.getElementById('pythonButton');
                var javascriptButton = document.getElementById('javascriptButton');
                var cppButton = document.getElementById('cppButton');
                var codeTitle = document.querySelector('.code-title');

                pythonButton.className = 'language-button inactive-language';
                javascriptButton.className = 'language-button inactive-language';
                cppButton.className = 'language-button inactive-language';

                if (language === 'python') {
                    pythonButton.className = 'language-button active-language';
                    codeTitle.textContent = '실제 코드 (Python)';
                    updateCode();
                } else if (language === 'javascript') {
                    javascriptButton.className = 'language-button active-language';
                    codeTitle.textContent = '실제 코드 (JavaScript)';
                    updateCode();
                } else if (language === 'cpp') {
                    cppButton.className = 'language-button active-language';
                    codeTitle.textContent = '실제 코드 (C++)';
                    updateCode();
                }
            }

            // 이벤트 리스너 설정
            document.getElementById('runButton').addEventListener('click', runCode);
            document.getElementById('runButtonSmall').addEventListener('click', runCode);
            document.getElementById('stopButton').addEventListener('click', stopCode);
            document.getElementById('resetButton').addEventListener('click', resetCharacter);
            document.getElementById('saveButton').addEventListener('click', saveProgram);
            document.getElementById('loadButton').addEventListener('click', loadProgram);

            // 언어 버튼 이벤트 리스너
            document.getElementById('pythonButton').addEventListener('click', function () {
                switchLanguage('python');
            });
            document.getElementById('javascriptButton').addEventListener('click', function () {
                switchLanguage('javascript');
            });
            document.getElementById('cppButton').addEventListener('click', function () {
                switchLanguage('cpp');
            });

            // 샘플 프로그램 로드
            loadSampleProgram();

            // 창 크기 조정 시 Blockly 재조정
            window.addEventListener('resize', function () {
                Blockly.svgResize(workspace);
            });

            // 키보드 단축키 설정
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case '1':
                            e.preventDefault();
                            navigationManager.navigateToDashboard();
                            break;
                        case '2':
                            e.preventDefault();
                            // 현재 페이지이므로 아무것도 하지 않음
                            break;
                        case '3':
                            e.preventDefault();
                            navigationManager.navigateTo('algorithm');
                            break;
                        case '4':
                            e.preventDefault();
                            navigationManager.navigateTo('assignments');
                            break;
                        case '5':
                            e.preventDefault();
                            navigationManager.navigateTo('progress');
                            break;
                        case 's':
                            e.preventDefault();
                            saveProgram();
                            break;
                        case 'o':
                            e.preventDefault();
                            loadProgram();
                            break;
                        case 'r':
                            e.preventDefault();
                            runCode();
                            break;
                    }
                }

                if (e.key === 'Escape') {
                    stopCode();
                }
            });

            // 페이지 이탈 시 확인
            window.addEventListener('beforeunload', function (e) {
                if (workspace.getAllBlocks(false).length > 0) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });
    </script>
</body>
</html>