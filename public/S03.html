<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì½”ë”©ìŠ¤íƒ€íŠ¸: ë¸”ë¡ ì½”ë”© í™˜ê²½</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/blockly_compressed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/blocks_compressed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/javascript_compressed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/python_compressed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/msg/ko.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            margin: 0 auto;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }

        .header {
            height: 60px;
            background: linear-gradient(135deg, #4285f4, #2a5298);
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-title {
            color: white;
            font-weight: bold;
            font-size: 22px;
            margin-right: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-title:hover {
            transform: scale(1.05);
        }

        .project-name {
            height: 30px;
            width: 200px;
            border-radius: 5px;
            border: none;
            padding: 0 10px;
            margin-right: 20px;
        }

        .header-button {
            height: 30px;
            padding: 0 15px;
            border-radius: 15px;
            border: none;
            background-color: rgba(255,255,255,0.2);
            color: white;
            font-size: 14px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-button:hover {
            background-color: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .back-button {
            background-color: rgba(255,255,255,0.1);
            margin-right: auto;
        }

        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .left-panel {
            width: 280px;
            border-right: 1px solid #ddd;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
        }

        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .workspace-controls {
            height: 40px;
            background-color: #eee;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        .workspace-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .minimap {
            width: 100px;
            height: 30px;
            background-color: #f1f3f4;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
        }

        #blocklyDiv {
            flex: 1;
            border-top: 1px solid #ddd;
            min-height: 400px;
        }

        .status-bar {
            height: 30px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #ddd;
        }

        .right-panel {
            width: 280px;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .result-header {
            height: 40px;
            background-color: #eee;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        .result-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .control-buttons {
            display: flex;
        }

        .control-button {
            width: 30px;
            height: 30px;
            border-radius: 15px;
            border: none;
            margin-left: 10px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            transform: scale(1.1);
        }

        .run-button {
            background-color: #4285f4;
        }

        .stop-button {
            background-color: #fbbc05;
        }

        .reset-button {
            background-color: #34a853;
        }

        .result-canvas {
            height: 200px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            margin: 10px;
            position: relative;
            overflow: hidden;
        }

        .character {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid #3b78e7;
            transform-origin: 50% 100%;
            transition: all 0.1s ease;
        }

        .console {
            height: 150px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            margin: 10px;
            padding: 10px;
            overflow-y: auto;
            font-size: 12px;
            font-family: monospace;
        }

        .console-line {
            margin: 2px 0;
            color: #333;
        }

        .variable-monitor {
            flex: 1;
            background-color: #fff;
            border: 1px solid #ddd;
            margin: 10px;
            padding: 10px;
            overflow-y: auto;
        }

        .variable-monitor-title {
            font-weight: bold;
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
        }

        .variable-item {
            height: 30px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            padding: 0 10px;
            display: flex;
            align-items: center;
            font-size: 12px;
            border-radius: 3px;
        }

        .code-panel {
            height: 200px;
            background-color: #292d3e;
            border: 1px solid #1e2132;
            display: flex;
            flex-direction: column;
        }

        .code-header {
            height: 40px;
            background-color: #1e2132;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        .code-title {
            font-weight: bold;
            font-size: 16px;
            color: white;
        }

        .language-buttons {
            display: flex;
        }

        .language-button {
            width: 80px;
            height: 30px;
            border-radius: 5px;
            margin-left: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .active-language {
            background-color: #3b78e7;
            border: none;
        }

        .inactive-language {
            background-color: #292d3e;
            border: 1px solid #3b78e7;
        }

        .inactive-language:hover {
            background-color: #3b78e7;
        }

        .code-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            color: #a6accd;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .navigation-notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }

        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            padding: 10px;
            border-radius: 4px;
            margin: 10px;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="main-container">
        <div class="header">
            <div class="header-title" id="logoTitle">ğŸš€ ì½”ë”©ìŠ¤íƒ€íŠ¸: ë¸”ë¡ ì½”ë”©</div>
            <button class="header-button back-button" id="backButton">â† ëŒ€ì‹œë³´ë“œ</button>
            <input type="text" class="project-name" value="ë‚´ í”„ë¡œì íŠ¸" id="projectName">
            <div style="flex-grow: 1;"></div>
            <button class="header-button" id="runButton">ì‹¤í–‰</button>
            <button class="header-button" id="saveButton">ì €ì¥</button>
            <button class="header-button" id="loadButton">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        
        <div class="content">
            <div class="left-panel">
                <!-- íˆ´ë°•ìŠ¤ëŠ” JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
            
            <div class="center-panel">
                <div class="workspace-controls">
                    <div class="workspace-title">ì½”ë“œ ì‘ì„± ì˜ì—­</div>
                    <div class="minimap">ë¸”ë¡ ì‘ì—…ê³µê°„</div>
                </div>
                <div id="blocklyDiv"></div>
                <div class="status-bar">
                    <span id="blockCount">ë¸”ë¡ ìˆ˜: 0</span> | 
                    <span id="lastSaved">ë§ˆì§€ë§‰ ì €ì¥: --:-- --</span> | 
                    <span id="executionStatus">ì¤€ë¹„ë¨</span>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="result-header">
                    <div class="result-title">ì‹¤í–‰ ê²°ê³¼</div>
                    <div class="control-buttons">
                        <button class="control-button run-button" id="runButtonSmall" title="ì‹¤í–‰">â–¶</button>
                        <button class="control-button stop-button" id="stopButton" title="ì •ì§€">â– </button>
                        <button class="control-button reset-button" id="resetButton" title="ë¦¬ì…‹">â†»</button>
                    </div>
                </div>
                
                <div class="result-canvas" id="canvas">
                    <div class="character" id="character"></div>
                </div>
                
                <div class="console" id="console">
                    <div class="console-line">> í”„ë¡œê·¸ë¨ ì‹œì‘ ì¤€ë¹„</div>
                </div>
                
                <div class="variable-monitor">
                    <div class="variable-monitor-title">ë³€ìˆ˜ ëª¨ë‹ˆí„°</div>
                    <div id="variables"></div>
                </div>
            </div>
        </div>
        
        <div class="code-panel">
            <div class="code-header">
                <div class="code-title">ìƒì„±ëœ ì½”ë“œ (Python)</div>
                <div class="language-buttons">
                    <div class="language-button active-language" id="pythonButton">Python</div>
                    <div class="language-button inactive-language" id="javascriptButton">JavaScript</div>
                    <div class="language-button inactive-language" id="cppButton">C++</div>
                </div>
            </div>
            <div class="code-content" id="codeContent"># ë¸”ë¡ì„ ì—°ê²°í•˜ë©´ ì—¬ê¸°ì— ì½”ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤</div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
        let workspace = null;
        let character = null;
        let x = 130;
        let y = 130;
        let angle = 0;
        let variables = {};
        let isRunning = false;
        let shouldStop = false;
        let navigationManager = null;

        // í†µí•© ë„¤ë¹„ê²Œì´ì…˜ ì‹œìŠ¤í…œ
        class NavigationManager {
            constructor() {
                this.currentUser = null;
                this.routes = {
                    'dashboard': '/dashboard',
                    'block-coding': '/block-coding',
                    'algorithm': '/algorithm',
                    'assignments': '/assignments',
                    'progress': '/progress',
                    'teacher-dashboard': '/teacher-dashboard',
                    'create-assignment': '/create-assignment',
                    'review-submissions': '/review-submissions',
                    'student-analytics': '/student-analytics',
                    'student-management': '/student-management',
                    'login': '/login'
                };
                this.init();
            }

            init() {
                this.loadUserInfo();
                this.setupEventListeners();
            }

            loadUserInfo() {
                const token = localStorage.getItem('authToken');
                const userJSON = localStorage.getItem('user');

                if (!token || !userJSON) {
                    this.redirectToLogin();
                    return false;
                }

                try {
                    this.currentUser = JSON.parse(userJSON);
                    return true;
                } catch (error) {
                    console.error('ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:', error);
                    this.clearAuthAndRedirect();
                    return false;
                }
            }

            setupEventListeners() {
                const logoTitle = document.getElementById('logoTitle');
                if (logoTitle) {
                    logoTitle.addEventListener('click', () => {
                        this.navigateToDashboard();
                    });
                }

                const backButton = document.getElementById('backButton');
                if (backButton) {
                    backButton.addEventListener('click', () => {
                        this.navigateToDashboard();
                    });
                }
            }

            navigateToDashboard() {
                if (this.currentUser && (this.currentUser.role === 'professor' || this.currentUser.role === 'admin')) {
                    this.navigateTo('teacher-dashboard');
                } else {
                    this.navigateTo('dashboard');
                }
            }

            navigateTo(routeName) {
                if (this.routes[routeName]) {
                    this.showLoading();
                    setTimeout(() => {
                        window.location.href = this.routes[routeName];
                    }, 300);
                } else {
                    console.error(`Route not found: ${routeName}`);
                }
            }

            redirectToLogin() {
                this.showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                setTimeout(() => {
                    window.location.href = this.routes.login;
                }, 1500);
            }

            clearAuthAndRedirect() {
                localStorage.clear();
                this.redirectToLogin();
            }

            showLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('active');
                }
            }

            hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.remove('active');
                }
            }

            showNotification(message, type = 'success') {
                const existingNotification = document.getElementById('navigationNotification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                const notification = document.createElement('div');
                notification.id = 'navigationNotification';
                notification.className = 'navigation-notification';
                notification.textContent = message;

                const backgroundColor = type === 'error'
                    ? 'linear-gradient(135deg, #f44336, #d32f2f)'
                    : 'linear-gradient(135deg, #4CAF50, #45a049)';

                notification.style.background = backgroundColor;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);

                setTimeout(() => {
                    notification.style.transform = 'translateX(400px)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ë„¤ë¹„ê²Œì´ì…˜ ë§¤ë‹ˆì € ì´ˆê¸°í™”
            navigationManager = new NavigationManager();
            
            // ë¡œë”© ì¢…ë£Œ
            if (navigationManager) {
                navigationManager.hideLoading();
            }

            // ìºë¦­í„° ìš”ì†Œ ì´ˆê¸°í™”
            character = document.getElementById('character');
            resetCharacter();

            // ì»¤ìŠ¤í…€ ë¸”ë¡ ì •ì˜
            defineCustomBlocks();
            
            // ì½”ë“œ ìƒì„±ê¸° ì •ì˜
            defineCodeGenerators();
            
            // Blockly ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ˆê¸°í™”
            initializeBlockly();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners();
            
            // ì´ˆê¸° í™”ë©´ ì—…ë°ì´íŠ¸
            updateCode();
            updateBlockCount();
            updateVariableDisplay();
        });

        // ì»¤ìŠ¤í…€ ë¸”ë¡ ì •ì˜
        function defineCustomBlocks() {
            // ì‹œì‘ ë¸”ë¡
            Blockly.Blocks['start'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("ğŸš€ ì‹œì‘í•˜ê¸°");
                    this.setNextStatement(true, null);
                    this.setColour(120);
                    this.setTooltip("í”„ë¡œê·¸ë¨ì´ ì‹œì‘ë  ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.");
                }
            };

            // ì•ìœ¼ë¡œ ì´ë™ ë¸”ë¡
            Blockly.Blocks['move_forward'] = {
                init: function() {
                    this.appendValueInput("DISTANCE")
                        .setCheck("Number")
                        .appendField("ğŸ”¼ ì•ìœ¼ë¡œ");
                    this.appendDummyInput()
                        .appendField("ë§Œí¼ ì´ë™");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(210);
                    this.setTooltip("ìºë¦­í„°ë¥¼ ì•ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.");
                }
            };

            // ì˜¤ë¥¸ìª½ íšŒì „ ë¸”ë¡
            Blockly.Blocks['turn_right'] = {
                init: function() {
                    this.appendValueInput("ANGLE")
                        .setCheck("Number")
                        .appendField("â¡ï¸ ì˜¤ë¥¸ìª½ìœ¼ë¡œ");
                    this.appendDummyInput()
                        .appendField("ë„ íšŒì „");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(210);
                    this.setTooltip("ìºë¦­í„°ë¥¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ íšŒì „ì‹œí‚µë‹ˆë‹¤.");
                }
            };

            // ì™¼ìª½ íšŒì „ ë¸”ë¡
            Blockly.Blocks['turn_left'] = {
                init: function() {
                    this.appendValueInput("ANGLE")
                        .setCheck("Number")
                        .appendField("â¬…ï¸ ì™¼ìª½ìœ¼ë¡œ");
                    this.appendDummyInput()
                        .appendField("ë„ íšŒì „");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(210);
                    this.setTooltip("ìºë¦­í„°ë¥¼ ì™¼ìª½ìœ¼ë¡œ íšŒì „ì‹œí‚µë‹ˆë‹¤.");
                }
            };

            // ëŒ€ê¸° ë¸”ë¡
            Blockly.Blocks['wait'] = {
                init: function() {
                    this.appendValueInput("TIME")
                        .setCheck("Number")
                        .appendField("â±ï¸ ëŒ€ê¸°");
                    this.appendDummyInput()
                        .appendField("ì´ˆ");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(290);
                    this.setTooltip("ì§€ì •ëœ ì‹œê°„(ì´ˆ) ë™ì•ˆ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.");
                }
            };
        }

        // ì½”ë“œ ìƒì„±ê¸° ì •ì˜
        function defineCodeGenerators() {
            // JavaScript ì½”ë“œ ìƒì„±ê¸°
            Blockly.JavaScript['start'] = function(block) {
                return '// í”„ë¡œê·¸ë¨ ì‹œì‘\n';
            };

            Blockly.JavaScript['move_forward'] = function(block) {
                const distance = Blockly.JavaScript.valueToCode(block, 'DISTANCE', Blockly.JavaScript.ORDER_ATOMIC) || '10';
                return `await moveForward(${distance});\n`;
            };

            Blockly.JavaScript['turn_right'] = function(block) {
                const angle = Blockly.JavaScript.valueToCode(block, 'ANGLE', Blockly.JavaScript.ORDER_ATOMIC) || '90';
                return `await turnRight(${angle});\n`;
            };

            Blockly.JavaScript['turn_left'] = function(block) {
                const angle = Blockly.JavaScript.valueToCode(block, 'ANGLE', Blockly.JavaScript.ORDER_ATOMIC) || '90';
                return `await turnLeft(${angle});\n`;
            };

            Blockly.JavaScript['wait'] = function(block) {
                const time = Blockly.JavaScript.valueToCode(block, 'TIME', Blockly.JavaScript.ORDER_ATOMIC) || '1';
                return `await sleep(${time});\n`;
            };

            // Python ì½”ë“œ ìƒì„±ê¸°
            Blockly.Python['start'] = function(block) {
                return '# í”„ë¡œê·¸ë¨ ì‹œì‘\n';
            };

            Blockly.Python['move_forward'] = function(block) {
                const distance = Blockly.Python.valueToCode(block, 'DISTANCE', Blockly.Python.ORDER_ATOMIC) || '10';
                return `move_forward(${distance})\n`;
            };

            Blockly.Python['turn_right'] = function(block) {
                const angle = Blockly.Python.valueToCode(block, 'ANGLE', Blockly.Python.ORDER_ATOMIC) || '90';
                return `turn_right(${angle})\n`;
            };

            Blockly.Python['turn_left'] = function(block) {
                const angle = Blockly.Python.valueToCode(block, 'ANGLE', Blockly.Python.ORDER_ATOMIC) || '90';
                return `turn_left(${angle})\n`;
            };

            Blockly.Python['wait'] = function(block) {
                const time = Blockly.Python.valueToCode(block, 'TIME', Blockly.Python.ORDER_ATOMIC) || '1';
                return `time.sleep(${time})\n`;
            };

            // ë³€ìˆ˜ ê´€ë ¨ ì½”ë“œ ìƒì„±ê¸°
            Blockly.JavaScript['variables_set'] = function(block) {
                const value = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ASSIGNMENT) || '0';
                const varId = block.getFieldValue('VAR');
                const varName = block.workspace.getVariableById(varId).name;
                return `updateVariable("${varName}", ${value});\n`;
            };

            Blockly.JavaScript['variables_get'] = function(block) {
                const varId = block.getFieldValue('VAR');
                const varName = block.workspace.getVariableById(varId).name;
                return [`variables["${varName}"] || 0`, Blockly.JavaScript.ORDER_ATOMIC];
            };

            Blockly.JavaScript['math_change'] = function(block) {
                const delta = Blockly.JavaScript.valueToCode(block, 'DELTA', Blockly.JavaScript.ORDER_ADDITION) || '0';
                const varId = block.getFieldValue('VAR');
                const varName = block.workspace.getVariableById(varId).name;
                return `updateVariable("${varName}", (variables["${varName}"] || 0) + ${delta});\n`;
            };
        }

        // Blockly ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ˆê¸°í™”
        function initializeBlockly() {
            const toolbox = {
                kind: 'categoryToolbox',
                contents: [
                    {
                        kind: 'category',
                        name: 'ğŸ¯ ì œì–´',
                        colour: 120,
                        contents: [
                            {
                                kind: 'block',
                                type: 'start'
                            },
                            {
                                kind: 'block',
                                type: 'controls_repeat_ext',
                                inputs: {
                                    TIMES: {
                                        shadow: {
                                            type: 'math_number',
                                            fields: { NUM: 4 }
                                        }
                                    }
                                }
                            },
                            {
                                kind: 'block',
                                type: 'controls_if'
                            },
                            {
                                kind: 'block',
                                type: 'wait',
                                inputs: {
                                    TIME: {
                                        shadow: {
                                            type: 'math_number',
                                            fields: { NUM: 1 }
                                        }
                                    }
                                }
                            }
                        ]
                    },
                    {
                        kind: 'category',
                        name: 'ğŸš€ ì›€ì§ì„',
                        colour: 210,
                        contents: [
                            {
                                kind: 'block',
                                type: 'move_forward',
                                inputs: {
                                    DISTANCE: {
                                        shadow: {
                                            type: 'math_number',
                                            fields: { NUM: 50 }
                                        }
                                    }
                                }
                            },
                            {
                                kind: 'block',
                                type: 'turn_right',
                                inputs: {
                                    ANGLE: {
                                        shadow: {
                                            type: 'math_number',
                                            fields: { NUM: 90 }
                                        }
                                    }
                                }
                            },
                            {
                                kind: 'block',
                                type: 'turn_left',
                                inputs: {
                                    ANGLE: {
                                        shadow: {
                                            type: 'math_number',
                                            fields: { NUM: 90 }
                                        }
                                    }
                                }
                            }
                        ]
                    },
                    {
                        kind: 'category',
                        name: 'ğŸ”¢ ìˆ˜í•™',
                        colour: 230,
                        contents: [
                            {
                                kind: 'block',
                                type: 'math_number',
                                fields: { NUM: 10 }
                            },
                            {
                                kind: 'block',
                                type: 'math_arithmetic',
                                inputs: {
                                    A: {
                                        shadow: {
                                            type: 'math_number',
                                            fields: { NUM: 1 }
                                        }
                                    },
                                    B: {
                                        shadow: {
                                            type: 'math_number',
                                            fields: { NUM: 1 }
                                        }
                                    }
                                }
                            },
                            {
                                kind: 'block',
                                type: 'math_random_int',
                                inputs: {
                                    FROM: {
                                        shadow: {
                                            type: 'math_number',
                                            fields: { NUM: 1 }
                                        }
                                    },
                                    TO: {
                                        shadow: {
                                            type: 'math_number',
                                            fields: { NUM: 100 }
                                        }
                                    }
                                }
                            }
                        ]
                    },
                    {
                        kind: 'category',
                        name: 'ğŸ§  ë…¼ë¦¬',
                        colour: 210,
                        contents: [
                            {
                                kind: 'block',
                                type: 'logic_compare'
                            },
                            {
                                kind: 'block',
                                type: 'logic_operation'
                            },
                            {
                                kind: 'block',
                                type: 'logic_boolean'
                            },
                            {
                                kind: 'block',
                                type: 'logic_negate'
                            }
                        ]
                    },
                    {
                        kind: 'category',
                        name: 'ğŸ“¦ ë³€ìˆ˜',
                        colour: 330,
                        custom: 'VARIABLE'
                    }
                ]
            };

            workspace = Blockly.inject('blocklyDiv', {
                toolbox: toolbox,
                grid: {
                    spacing: 20,
                    length: 3,
                    colour: '#ccc',
                    snap: true
                },
                zoom: {
                    controls: true,
                    wheel: true,
                    startScale: 1.0,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                trashcan: true,
                sounds: false,
                move: {
                    scrollbars: true,
                    drag: true,
                    wheel: true
                }
            });

            // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            workspace.addChangeListener(function(event) {
                if (event.type === Blockly.Events.BLOCK_CREATE ||
                    event.type === Blockly.Events.BLOCK_DELETE ||
                    event.type === Blockly.Events.BLOCK_CHANGE ||
                    event.type === Blockly.Events.BLOCK_MOVE ||
                    event.type === Blockly.Events.VAR_CREATE ||
                    event.type === Blockly.Events.VAR_DELETE ||
                    event.type === Blockly.Events.VAR_RENAME) {
                    
                    updateCode();
                    updateBlockCount();
                    
                    // ë³€ìˆ˜ ê´€ë ¨ ì´ë²¤íŠ¸ ì²˜ë¦¬
                    if (event.type === Blockly.Events.VAR_CREATE || 
                        event.type === Blockly.Events.VAR_RENAME) {
                        const variableList = workspace.getAllVariables();
                        variableList.forEach(variable => {
                            if (!(variable.name in variables)) {
                                updateVariable(variable.name, 0);
                            }
                        });
                    }
                }
            });

            // ìƒ˜í”Œ í”„ë¡œê·¸ë¨ ë¡œë“œ
            loadSampleProgram();
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // ì‹¤í–‰ ë²„íŠ¼ë“¤
            document.getElementById('runButton').addEventListener('click', runCode);
            document.getElementById('runButtonSmall').addEventListener('click', runCode);
            
            // ì œì–´ ë²„íŠ¼ë“¤
            document.getElementById('stopButton').addEventListener('click', stopCode);
            document.getElementById('resetButton').addEventListener('click', resetCharacter);
            
            // ì €ì¥/ë¡œë“œ ë²„íŠ¼ë“¤
            document.getElementById('saveButton').addEventListener('click', saveProgram);
            document.getElementById('loadButton').addEventListener('click', loadProgram);
            
            // ì–¸ì–´ ì „í™˜ ë²„íŠ¼ë“¤
            document.getElementById('pythonButton').addEventListener('click', () => switchLanguage('python'));
            document.getElementById('javascriptButton').addEventListener('click', () => switchLanguage('javascript'));
            document.getElementById('cppButton').addEventListener('click', () => switchLanguage('cpp'));
            
            // ì°½ í¬ê¸° ì¡°ì • ì´ë²¤íŠ¸
            window.addEventListener('resize', function() {
                if (workspace) {
                    Blockly.svgResize(workspace);
                }
            });
            
            // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            // í˜ì´ì§€ ì´íƒˆ ê²½ê³ 
            window.addEventListener('beforeunload', function(e) {
                if (workspace && workspace.getAllBlocks(false).length > 0) {
                    e.preventDefault();
                    e.returnValue = 'ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ í˜ì´ì§€ë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                }
            });
        }

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì²˜ë¦¬
        function handleKeyboardShortcuts(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        if (navigationManager) navigationManager.navigateToDashboard();
                        break;
                    case 's':
                        e.preventDefault();
                        saveProgram();
                        break;
                    case 'o':
                        e.preventDefault();
                        loadProgram();
                        break;
                    case 'r':
                        e.preventDefault();
                        runCode();
                        break;
                }
            }
            
            if (e.key === 'Escape') {
                stopCode();
            }
        }

        // ìƒ˜í”Œ í”„ë¡œê·¸ë¨ ë¡œë“œ
        function loadSampleProgram() {
            const sampleXml = `
<xml xmlns="https://developers.google.com/blockly/xml">
  <variables>
    <variable id="counter">ì¹´ìš´í„°</variable>
  </variables>
  <block type="start" id="start_block" x="250" y="150">
    <next>
      <block type="variables_set" id="init_counter">
        <field name="VAR" id="counter">ì¹´ìš´í„°</field>
        <value name="VALUE">
          <block type="math_number">
            <field name="NUM">0</field>
          </block>
        </value>
        <next>
          <block type="controls_repeat_ext" id="main_loop">
            <value name="TIMES">
              <shadow type="math_number">
                <field name="NUM">4</field>
              </shadow>
            </value>
            <statement name="DO">
              <block type="move_forward" id="move1">
                <value name="DISTANCE">
                  <shadow type="math_number">
                    <field name="NUM">60</field>
                  </shadow>
                </value>
                <next>
                  <block type="turn_right" id="turn1">
                    <value name="ANGLE">
                      <shadow type="math_number">
                        <field name="NUM">90</field>
                      </shadow>
                    </value>
                    <next>
                      <block type="math_change" id="increment">
                        <field name="VAR" id="counter">ì¹´ìš´í„°</field>
                        <value name="DELTA">
                          <shadow type="math_number">
                            <field name="NUM">1</field>
                          </shadow>
                        </value>
                        <next>
                          <block type="wait" id="wait1">
                            <value name="TIME">
                              <shadow type="math_number">
                                <field name="NUM">0.5</field>
                              </shadow>
                            </value>
                          </block>
                        </next>
                      </block>
                    </next>
                  </block>
                </next>
              </block>
            </statement>
          </block>
        </next>
      </block>
    </next>
  </block>
</xml>`;

            try {
                const xml = Blockly.Xml.textToDom(sampleXml);
                Blockly.Xml.domToWorkspace(xml, workspace);
                updateCode();
                updateBlockCount();
                logToConsole('ìƒ˜í”Œ í”„ë¡œê·¸ë¨ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ìƒ˜í”Œ í”„ë¡œê·¸ë¨ ë¡œë“œ ì˜¤ë¥˜:', error);
                logToConsole('ìƒ˜í”Œ í”„ë¡œê·¸ë¨ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì½”ë“œ ìƒì„± ë° ì—…ë°ì´íŠ¸
        function updateCode() {
            if (!workspace) return;

            try {
                const activeLanguage = document.querySelector('.language-button.active-language').id;
                let code = '';

                switch (activeLanguage) {
                    case 'pythonButton':
                        code = generatePythonCode();
                        break;
                    case 'javascriptButton':
                        code = generateJavaScriptCode();
                        break;
                    case 'cppButton':
                        code = generateCppCode();
                        break;
                    default:
                        code = generatePythonCode();
                }

                document.getElementById('codeContent').textContent = code;
            } catch (error) {
                console.error('ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', error);
                document.getElementById('codeContent').textContent = '# ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n# ' + error.message;
            }
        }

        // Python ì½”ë“œ ìƒì„±
        function generatePythonCode() {
            const pythonCode = Blockly.Python.workspaceToCode(workspace);
            const variableList = workspace.getAllVariables();
            
            let imports = 'import time\n\n';
            let functions = `def move_forward(distance):
    print(f"ì•ìœ¼ë¡œ {distance}ë§Œí¼ ì´ë™")

def turn_right(angle):
    print(f"ì˜¤ë¥¸ìª½ìœ¼ë¡œ {angle}ë„ íšŒì „")

def turn_left(angle):
    print(f"ì™¼ìª½ìœ¼ë¡œ {angle}ë„ íšŒì „")

def wait(seconds):
    time.sleep(seconds)

`;

            let mainFunction = 'def main():\n';
            
            // ë³€ìˆ˜ ì´ˆê¸°í™”
            if (variableList.length > 0) {
                mainFunction += '    # ë³€ìˆ˜ ì´ˆê¸°í™”\n';
                variableList.forEach(variable => {
                    mainFunction += `    ${variable.name} = 0\n`;
                });
                mainFunction += '\n';
            }
            
            // ìƒì„±ëœ ì½”ë“œ ì¶”ê°€
            const indentedCode = pythonCode.split('\n')
                .map(line => line ? '    ' + line : '')
                .join('\n');
            
            mainFunction += '    # í”„ë¡œê·¸ë¨ ì‹œì‘\n' + indentedCode;
            mainFunction += '\n\nif __name__ == "__main__":\n    main()';

            return imports + functions + mainFunction;
        }

        // JavaScript ì½”ë“œ ìƒì„±
        function generateJavaScriptCode() {
            const jsCode = Blockly.JavaScript.workspaceToCode(workspace);
            const variableList = workspace.getAllVariables();
            
            let code = `// ìƒì„±ëœ JavaScript ì½”ë“œ
const variables = {};

// í•¨ìˆ˜ ì •ì˜
async function moveForward(distance) {
    console.log(\`ì•ìœ¼ë¡œ \${distance}ë§Œí¼ ì´ë™\`);
    // ì‹¤ì œ ì›€ì§ì„ êµ¬í˜„
}

async function turnRight(angle) {
    console.log(\`ì˜¤ë¥¸ìª½ìœ¼ë¡œ \${angle}ë„ íšŒì „\`);
    // ì‹¤ì œ íšŒì „ êµ¬í˜„
}

async function turnLeft(angle) {
    console.log(\`ì™¼ìª½ìœ¼ë¡œ \${angle}ë„ íšŒì „\`);
    // ì‹¤ì œ íšŒì „ êµ¬í˜„
}

async function sleep(seconds) {
    return new Promise(resolve => setTimeout(resolve, seconds * 1000));
}

function updateVariable(name, value) {
    variables[name] = value;
    console.log(\`ë³€ìˆ˜ \${name}ì˜ ê°’ì´ \${value}ë¡œ ë³€ê²½ë¨\`);
}

// ë©”ì¸ í•¨ìˆ˜
async function main() {
`;

            // ë³€ìˆ˜ ì´ˆê¸°í™”
            if (variableList.length > 0) {
                code += '    // ë³€ìˆ˜ ì´ˆê¸°í™”\n';
                variableList.forEach(variable => {
                    code += `    updateVariable("${variable.name}", 0);\n`;
                });
                code += '\n';
            }

            // ìƒì„±ëœ ì½”ë“œ ì¶”ê°€
            const indentedCode = jsCode.split('\n')
                .map(line => line ? '    ' + line : '')
                .join('\n');
            
            code += '    // í”„ë¡œê·¸ë¨ ì‹œì‘\n' + indentedCode;
            code += '\n}\n\n// ì‹¤í–‰\nmain().catch(console.error);';

            return code;
        }

        // C++ ì½”ë“œ ìƒì„±
        function generateCppCode() {
            const variableList = workspace.getAllVariables();
            
            let code = `// ìƒì„±ëœ C++ ì½”ë“œ
#include <iostream>
#include <chrono>
#include <thread>
#include <map>
#include <string>

using namespace std;

// ì „ì—­ ë³€ìˆ˜
map<string, int> variables;

// í•¨ìˆ˜ ì •ì˜
void moveForward(int distance) {
    cout << "ì•ìœ¼ë¡œ " << distance << "ë§Œí¼ ì´ë™" << endl;
}

void turnRight(int angle) {
    cout << "ì˜¤ë¥¸ìª½ìœ¼ë¡œ " << angle << "ë„ íšŒì „" << endl;
}

void turnLeft(int angle) {
    cout << "ì™¼ìª½ìœ¼ë¡œ " << angle << "ë„ íšŒì „" << endl;
}

void wait(double seconds) {
    this_thread::sleep_for(chrono::milliseconds((int)(seconds * 1000)));
}

void updateVariable(const string& name, int value) {
    variables[name] = value;
    cout << "ë³€ìˆ˜ " << name << "ì˜ ê°’ì´ " << value << "ë¡œ ë³€ê²½ë¨" << endl;
}

int main() {
`;

            // ë³€ìˆ˜ ì´ˆê¸°í™”
            if (variableList.length > 0) {
                code += '    // ë³€ìˆ˜ ì´ˆê¸°í™”\n';
                variableList.forEach(variable => {
                    code += `    updateVariable("${variable.name}", 0);\n`;
                });
                code += '\n';
            }

            code += `    // í”„ë¡œê·¸ë¨ ì‹œì‘
    // ì—¬ê¸°ì— ë¸”ë¡ì—ì„œ ìƒì„±ëœ ì½”ë“œê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤
    moveForward(60);
    for (int i = 0; i < 4; i++) {
        moveForward(60);
        turnRight(90);
        updateVariable("ì¹´ìš´í„°", variables["ì¹´ìš´í„°"] + 1);
        wait(0.5);
    }
    
    return 0;
}`;

            return code;
        }

        // ë¸”ë¡ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updateBlockCount() {
            if (!workspace) return;
            const count = workspace.getAllBlocks(false).length;
            document.getElementById('blockCount').textContent = `ë¸”ë¡ ìˆ˜: ${count}`;
        }

        // ìºë¦­í„° ë¦¬ì…‹
        function resetCharacter() {
            x = 130;
            y = 130;
            angle = 0;
            variables = {};
            
            if (character) {
                character.style.left = x + 'px';
                character.style.top = y + 'px';
                character.style.transform = 'rotate(' + angle + 'deg)';
            }
            
            // ì½˜ì†” ì´ˆê¸°í™”
            const consoleDiv = document.getElementById('console');
            consoleDiv.innerHTML = '<div class="console-line">> í”„ë¡œê·¸ë¨ ì´ˆê¸°í™” ì™„ë£Œ</div>';
            
            // ì‹¤í–‰ ìƒíƒœ ì´ˆê¸°í™”
            isRunning = false;
            shouldStop = false;
            document.getElementById('executionStatus').textContent = 'ì¤€ë¹„ë¨';
            
            updateVariableDisplay();
            logToConsole('ìºë¦­í„°ì™€ ë³€ìˆ˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ë³€ìˆ˜ ì—…ë°ì´íŠ¸
        function updateVariable(name, value) {
            if (!isNaN(Number(value)) && value !== '') {
                value = Number(value);
            }
            variables[name] = value;
            updateVariableDisplay();
            logToConsole(`ë³€ìˆ˜ ${name}: ${value}`);
        }

        // ë³€ìˆ˜ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
        function updateVariableDisplay() {
            const variablesDiv = document.getElementById('variables');
            variablesDiv.innerHTML = '';

            // ì‚¬ìš©ì ì •ì˜ ë³€ìˆ˜ë“¤
            for (const [name, value] of Object.entries(variables)) {
                const item = document.createElement('div');
                item.className = 'variable-item';
                item.textContent = `${name}: ${value}`;
                variablesDiv.appendChild(item);
            }

            // ìœ„ì¹˜ ì •ë³´
            const posX = document.createElement('div');
            posX.className = 'variable-item';
            posX.textContent = `ìœ„ì¹˜ X: ${Math.round(x)}`;
            variablesDiv.appendChild(posX);

            const posY = document.createElement('div');
            posY.className = 'variable-item';
            posY.textContent = `ìœ„ì¹˜ Y: ${Math.round(y)}`;
            variablesDiv.appendChild(posY);

            const rotation = document.createElement('div');
            rotation.className = 'variable-item';
            rotation.textContent = `íšŒì „ê°: ${Math.round(angle)}Â°`;
            variablesDiv.appendChild(rotation);
        }

        // ì½˜ì†”ì— ë¡œê·¸ ì¶”ê°€
        function logToConsole(message) {
            const consoleDiv = document.getElementById('console');
            const line = document.createElement('div');
            line.className = 'console-line';
            line.textContent = '> ' + message;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // ì›€ì§ì„ í•¨ìˆ˜ë“¤
        async function moveForward(distance) {
            logToConsole(`ì•ìœ¼ë¡œ ${distance}ë§Œí¼ ì´ë™`);
            
            if (!character) return;
            
            const radians = angle * Math.PI / 180;
            const targetX = Math.max(10, Math.min(250, x + Math.sin(radians) * distance));
            const targetY = Math.max(10, Math.min(170, y - Math.cos(radians) * distance));
            
            const steps = Math.max(10, Math.abs(distance) / 2);
            const deltaX = (targetX - x) / steps;
            const deltaY = (targetY - y) / steps;
            
            for (let i = 0; i < steps && !shouldStop; i++) {
                x += deltaX;
                y += deltaY;
                character.style.left = x + 'px';
                character.style.top = y + 'px';
                updateVariableDisplay();
                await sleep(0.02);
            }
            
            x = targetX;
            y = targetY;
            character.style.left = x + 'px';
            character.style.top = y + 'px';
            updateVariableDisplay();
        }

        async function turnRight(degrees) {
            logToConsole(`ì˜¤ë¥¸ìª½ìœ¼ë¡œ ${degrees}ë„ íšŒì „`);
            
            if (!character) return;
            
            const targetAngle = angle + degrees;
            const steps = Math.max(5, Math.abs(degrees) / 10);
            const deltaAngle = degrees / steps;
            
            for (let i = 0; i < steps && !shouldStop; i++) {
                angle += deltaAngle;
                character.style.transform = `rotate(${angle}deg)`;
                updateVariableDisplay();
                await sleep(0.02);
            }
            
            angle = targetAngle % 360;
            character.style.transform = `rotate(${angle}deg)`;
            updateVariableDisplay();
        }

        async function turnLeft(degrees) {
            logToConsole(`ì™¼ìª½ìœ¼ë¡œ ${degrees}ë„ íšŒì „`);
            
            if (!character) return;
            
            const targetAngle = angle - degrees;
            const steps = Math.max(5, Math.abs(degrees) / 10);
            const deltaAngle = degrees / steps;
            
            for (let i = 0; i < steps && !shouldStop; i++) {
                angle -= deltaAngle;
                character.style.transform = `rotate(${angle}deg)`;
                updateVariableDisplay();
                await sleep(0.02);
            }
            
            angle = targetAngle % 360;
            character.style.transform = `rotate(${angle}deg)`;
            updateVariableDisplay();
        }

        // ì§€ì—° í•¨ìˆ˜
        function sleep(seconds) {
            return new Promise(resolve => setTimeout(resolve, seconds * 1000));
        }

        // ì½”ë“œ ì‹¤í–‰
        async function runCode() {
            if (isRunning) {
                logToConsole('ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.');
                return;
            }

            if (!workspace) {
                logToConsole('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const blocks = workspace.getAllBlocks(false);
            if (blocks.length === 0) {
                logToConsole('ì‹¤í–‰í•  ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            isRunning = true;
            shouldStop = false;
            document.getElementById('executionStatus').textContent = 'ì‹¤í–‰ ì¤‘...';
            
            logToConsole('í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì‹œì‘');

            try {
                // ë³€ìˆ˜ ì´ˆê¸°í™”
                const variableList = workspace.getAllVariables();
                variableList.forEach(variable => {
                    if (!(variable.name in variables)) {
                        variables[variable.name] = 0;
                    }
                });
                updateVariableDisplay();

                // ì½”ë“œ ìƒì„± ë° ì‹¤í–‰
                const code = Blockly.JavaScript.workspaceToCode(workspace);
                
                if (!code.trim()) {
                    logToConsole('ìƒì„±ëœ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ì•ˆì „í•œ ì½”ë“œ ì‹¤í–‰ì„ ìœ„í•œ í•¨ìˆ˜ ë˜í•‘
                const runFunction = new Function(
                    'moveForward', 'turnRight', 'turnLeft', 
                    'sleep', 'updateVariable', 'variables',
                    `return (async function() {
                        try {
                            ${code}
                        } catch (error) {
                            console.error("ì‹¤í–‰ ì˜¤ë¥˜:", error);
                            throw error;
                        }
                    })();`
                );

                await runFunction(
                    moveForward, turnRight, turnLeft,
                    sleep, updateVariable, variables
                );

                if (!shouldStop) {
                    logToConsole('í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì™„ë£Œ');
                    document.getElementById('executionStatus').textContent = 'ì™„ë£Œ';
                }
            } catch (error) {
                console.error('ì‹¤í–‰ ì˜¤ë¥˜:', error);
                logToConsole(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                document.getElementById('executionStatus').textContent = 'ì˜¤ë¥˜';
            } finally {
                isRunning = false;
                if (!shouldStop) {
                    setTimeout(() => {
                        document.getElementById('executionStatus').textContent = 'ì¤€ë¹„ë¨';
                    }, 2000);
                }
            }
        }

        // ì½”ë“œ ì‹¤í–‰ ì¤‘ì§€
        function stopCode() {
            if (!isRunning) {
                logToConsole('ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            shouldStop = true;
            logToConsole('í”„ë¡œê·¸ë¨ ì‹¤í–‰ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            document.getElementById('executionStatus').textContent = 'ì¤‘ì§€ë¨';
            
            setTimeout(() => {
                isRunning = false;
                document.getElementById('executionStatus').textContent = 'ì¤€ë¹„ë¨';
            }, 1000);
        }

        // í”„ë¡œê·¸ë¨ ì €ì¥
        function saveProgram() {
            if (!workspace) {
                logToConsole('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const xml = Blockly.Xml.workspaceToDom(workspace);
                const xmlText = Blockly.Xml.domToText(xml);
                const projectName = document.getElementById('projectName').value || 'ë‚´ í”„ë¡œì íŠ¸';
                
                localStorage.setItem('savedProgram', xmlText);
                localStorage.setItem('savedProjectName', projectName);

                const now = new Date();
                const timeString = now.toLocaleTimeString('ko-KR', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                document.getElementById('lastSaved').textContent = `ë§ˆì§€ë§‰ ì €ì¥: ${timeString}`;
                logToConsole(`í”„ë¡œì íŠ¸ "${projectName}"ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
                if (navigationManager) {
                    navigationManager.showNotification('í”„ë¡œì íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                logToConsole('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                if (navigationManager) {
                    navigationManager.showNotification('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }

        // í”„ë¡œê·¸ë¨ ë¡œë“œ
        function loadProgram() {
            const savedProgram = localStorage.getItem('savedProgram');
            const savedProjectName = localStorage.getItem('savedProjectName');
            
            if (!savedProgram) {
                logToConsole('ì €ì¥ëœ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.');
                if (navigationManager) {
                    navigationManager.showNotification('ì €ì¥ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                }
                return;
            }

            try {
                if (workspace) {
                    workspace.clear();
                    const xml = Blockly.Xml.textToDom(savedProgram);
                    Blockly.Xml.domToWorkspace(xml, workspace);
                    
                    if (savedProjectName) {
                        document.getElementById('projectName').value = savedProjectName;
                    }
                    
                    updateCode();
                    updateBlockCount();
                    logToConsole('ì €ì¥ëœ í”„ë¡œê·¸ë¨ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                    
                    if (navigationManager) {
                        navigationManager.showNotification('í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                    }
                }
            } catch (error) {
                console.error('ë¡œë“œ ì˜¤ë¥˜:', error);
                logToConsole('í”„ë¡œê·¸ë¨ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                if (navigationManager) {
                    navigationManager.showNotification('í”„ë¡œì íŠ¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }

        // ì–¸ì–´ ì „í™˜
        function switchLanguage(language) {
            const buttons = {
                python: document.getElementById('pythonButton'),
                javascript: document.getElementById('javascriptButton'),
                cpp: document.getElementById('cppButton')
            };
            
            const titles = {
                python: 'ìƒì„±ëœ ì½”ë“œ (Python)',
                javascript: 'ìƒì„±ëœ ì½”ë“œ (JavaScript)',
                cpp: 'ìƒì„±ëœ ì½”ë“œ (C++)'
            };

            // ëª¨ë“  ë²„íŠ¼ì„ ë¹„í™œì„±í™”
            Object.values(buttons).forEach(button => {
                button.className = 'language-button inactive-language';
            });

            // ì„ íƒëœ ë²„íŠ¼ í™œì„±í™”
            if (buttons[language]) {
                buttons[language].className = 'language-button active-language';
                document.querySelector('.code-title').textContent = titles[language];
                updateCode();
                logToConsole(`ì½”ë“œ ì–¸ì–´ê°€ ${language}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
        }
    </script>
</body>
</html>