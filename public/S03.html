<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì½”ë”©ìŠ¤íƒ€íŠ¸: ë¸”ë¡ ì½”ë”© í™˜ê²½</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/blockly_compressed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/blocks_compressed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/javascript_compressed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/python_compressed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/9.3.0/msg/ko.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            margin: 0 auto;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }

        .header {
            height: 60px;
            background: linear-gradient(135deg, #4285f4, #2a5298);
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-title {
            color: white;
            font-weight: bold;
            font-size: 22px;
            margin-right: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-title:hover {
            transform: scale(1.05);
        }

        .project-name {
            height: 30px;
            width: 200px;
            border-radius: 5px;
            border: none;
            padding: 0 10px;
            margin-right: 20px;
        }

        .header-button {
            height: 30px;
            padding: 0 15px;
            border-radius: 15px;
            border: none;
            background-color: rgba(255,255,255,0.2);
            color: white;
            font-size: 14px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-button:hover {
            background-color: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .back-button {
            background-color: rgba(255,255,255,0.1);
            margin-right: auto;
        }

        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .category-tabs {
            height: 40px;
            background-color: #eee;
            display: flex;
            align-items: center;
            padding: 0 10px;
        }

        .category-tab {
            width: 40px;
            height: 30px;
            border-radius: 5px;
            margin-right: 10px;
            border: none;
            cursor: pointer;
        }

        .search-block {
            margin: 10px;
            position: relative;
        }

        .search-input {
            width: 100%;
            height: 30px;
            border-radius: 15px;
            border: 1px solid #ddd;
            padding: 0 15px;
            font-size: 12px;
        }

        .category-title {
            height: 30px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-weight: bold;
            color: white;
            font-size: 14px;
        }

        .blocks-container {
            overflow-y: auto;
            flex: 1;
        }

        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .workspace-controls {
            height: 40px;
            background-color: #eee;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        .workspace-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .minimap {
            width: 100px;
            height: 30px;
            background-color: #f1f3f4;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
        }

        #blocklyDiv {
            flex: 1;
            border-top: 1px solid #ddd;
        }

        .status-bar {
            height: 30px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #ddd;
        }

        .right-panel {
            width: 280px;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .result-header {
            height: 40px;
            background-color: #eee;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        .result-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .control-buttons {
            display: flex;
        }

        .control-button {
            width: 30px;
            height: 30px;
            border-radius: 15px;
            border: none;
            margin-left: 10px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            transform: scale(1.1);
        }

        .run-button {
            background-color: #4285f4;
        }

        .stop-button {
            background-color: #fbbc05;
        }

        .reset-button {
            background-color: #34a853;
        }

        .result-canvas {
            height: 260px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            margin: 10px;
            position: relative;
        }

        .character {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid #3b78e7;
            transform-origin: 50% 50%;
        }

        .console {
            height: 150px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            margin: 10px;
            padding: 10px;
            overflow-y: auto;
            font-size: 12px;
        }

        .console-line {
            margin: 5px 0;
        }

        .variable-monitor {
            flex: 1;
            background-color: #fff;
            border: 1px solid #ddd;
            margin: 10px;
            padding: 10px;
            overflow-y: auto;
        }

        .variable-monitor-title {
            font-weight: bold;
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
        }

        .variable-item {
            height: 30px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            padding: 0 15px;
            display: flex;
            align-items: center;
            font-size: 12px;
        }

        .code-panel {
            height: 260px;
            background-color: #292d3e;
            border: 1px solid #1e2132;
            display: flex;
            flex-direction: column;
        }

        .code-header {
            height: 40px;
            background-color: #1e2132;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        .code-title {
            font-weight: bold;
            font-size: 16px;
            color: white;
        }

        .language-buttons {
            display: flex;
        }

        .language-button {
            width: 80px;
            height: 30px;
            border-radius: 5px;
            margin-left: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .active-language {
            background-color: #3b78e7;
            border: none;
        }

        .inactive-language {
            background-color: #292d3e;
            border: 1px solid #3b78e7;
        }

        .inactive-language:hover {
            background-color: #3b78e7;
        }

        .code-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            color: #a6accd;
            font-family: Consolas, monospace;
            font-size: 14px;
            white-space: pre;
        }

        .code-tip {
            height: 30px;
            background-color: #333652;
            border: 1px solid #23293e;
            margin: 0 20px 20px;
            border-radius: 5px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #a6accd;
        }

        .category-control {
            background-color: #fbbc05;
        }

        .category-movement {
            background-color: #4285f4;
        }

        .category-variables {
            background-color: #ea4335;
        }

        .category-logic {
            background-color: #34a853;
        }

        /* í†µí•© ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .navigation-notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
    </style>
</head>

<body>
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="main-container">
        <div class="header">
            <div class="header-title" id="logoTitle">ğŸš€ ì½”ë”©ìŠ¤íƒ€íŠ¸: ë¸”ë¡ ì½”ë”©</div>
            <button class="header-button back-button" id="backButton">â† ëŒ€ì‹œë³´ë“œ</button>
            <input type="text" class="project-name" value="ë‚´ í”„ë¡œì íŠ¸">
            <div style="flex-grow: 1;"></div>
            <button class="header-button" id="runButton">ì‹¤í–‰</button>
            <button class="header-button" id="saveButton">ì €ì¥</button>
            <button class="header-button" id="loadButton">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <div class="content">
            <div class="left-panel">
                <div id="toolbox" style="display: none;">
                    <xml id="toolboxXML">
                        <category name="ì œì–´" colour="#fbbc05">
                            <block type="start"></block>
                            <block type="controls_repeat_ext">
                                <value name="TIMES">
                                    <shadow type="math_number">
                                        <field name="NUM">10</field>
                                    </shadow>
                                </value>
                            </block>
                            <block type="controls_if"></block>
                            <block type="wait">
                                <value name="TIME">
                                    <shadow type="math_number">
                                        <field name="NUM">1</field>
                                    </shadow>
                                </value>
                            </block>
                        </category>
                        <category name="ì›€ì§ì„" colour="#4285f4">
                            <block type="move_forward">
                                <value name="DISTANCE">
                                    <shadow type="math_number">
                                        <field name="NUM">10</field>
                                    </shadow>
                                </value>
                            </block>
                            <block type="turn_right">
                                <value name="ANGLE">
                                    <shadow type="math_number">
                                        <field name="NUM">90</field>
                                    </shadow>
                                </value>
                            </block>
                            <block type="turn_left">
                                <value name="ANGLE">
                                    <shadow type="math_number">
                                        <field name="NUM">90</field>
                                    </shadow>
                                </value>
                            </block>
                        </category>
                        <category name="ë…¼ë¦¬" colour="#34a853">
                            <block type="logic_compare"></block>
                            <block type="logic_operation"></block>
                            <block type="logic_boolean"></block>
                        </category>
                        <category name="ë³€ìˆ˜" colour="#ea4335" custom="VARIABLE"></category>
                        <category name="ìˆ˜í•™" colour="#9966FF">
                            <block type="math_number">
                                <field name="NUM">1</field>
                            </block>
                            <block type="math_arithmetic">
                                <value name="A">
                                    <shadow type="math_number">
                                        <field name="NUM">1</field>
                                    </shadow>
                                </value>
                                <value name="B">
                                    <shadow type="math_number">
                                        <field name="NUM">1</field>
                                    </shadow>
                                </value>
                            </block>
                            <block type="math_number_property">
                                <value name="NUMBER_TO_CHECK">
                                    <shadow type="math_number">
                                        <field name="NUM">0</field>
                                    </shadow>
                                </value>
                            </block>
                        </category>
                    </xml>
                </div>
                <div id="blocklyToolbox"></div>
            </div>
            <div class="center-panel">
                <div class="workspace-controls">
                    <div class="workspace-title">ì½”ë“œ ì‘ì„± ì˜ì—­</div>
                    <div class="minimap">ë¯¸ë‹ˆë§µ</div>
                </div>
                <div id="blocklyDiv"></div>
                <div class="status-bar">
                    <span id="blockCount">ë¸”ë¡ ìˆ˜: 0</span> | <span id="lastSaved">ë§ˆì§€ë§‰ ì €ì¥: --:-- --</span>
                </div>
            </div>
            <div class="right-panel">
                <div class="result-header">
                    <div class="result-title">ì‹¤í–‰ ê²°ê³¼</div>
                    <div class="control-buttons">
                        <button class="control-button run-button" id="runButtonSmall">â–¶</button>
                        <button class="control-button stop-button" id="stopButton">â– </button>
                        <button class="control-button reset-button" id="resetButton">â†»</button>
                    </div>
                </div>
                <div class="result-canvas" id="canvas">
                    <div class="character" id="character" style="left: 130px; top: 130px; transform: rotate(0deg);">
                    </div>
                </div>
                <div class="console" id="console">
                    <div class="console-line">> í”„ë¡œê·¸ë¨ ì‹œì‘</div>
                </div>
                <div class="variable-monitor">
                    <div class="variable-monitor-title">ë³€ìˆ˜ ëª¨ë‹ˆí„°</div>
                    <div id="variables"></div>
                </div>
            </div>
        </div>
        <div class="code-panel">
            <div class="code-header">
                <div class="code-title">ì‹¤ì œ ì½”ë“œ (Python)</div>
                <div class="language-buttons">
                    <div class="language-button active-language" id="pythonButton">Python</div>
                    <div class="language-button inactive-language" id="javascriptButton">JavaScript</div>
                    <div class="language-button inactive-language" id="cppButton">C++</div>
                </div>
            </div>
            <div class="code-content" id="codeContent"></div>
        </div>
    </div>

    <script>
        // í†µí•© ë„¤ë¹„ê²Œì´ì…˜ ì‹œìŠ¤í…œ
        class NavigationManager {
            constructor() {
                this.currentUser = null;
                this.routes = {
                    'dashboard': '/dashboard',
                    'block-coding': '/block-coding', 
                    'algorithm': '/algorithm',
                    'assignments': '/assignments',
                    'progress': '/progress',
                    'teacher-dashboard': '/teacher-dashboard',
                    'create-assignment': '/create-assignment',
                    'review-submissions': '/review-submissions',
                    'student-analytics': '/student-analytics',
                    'student-management': '/student-management',
                    'login': '/login'
                };
                
                this.init();
            }

            init() {
                this.loadUserInfo();
                this.setupEventListeners();
            }

            loadUserInfo() {
                const token = localStorage.getItem('authToken');
                const userJSON = localStorage.getItem('user');

                if (!token || !userJSON) {
                    this.redirectToLogin();
                    return false;
                }

                try {
                    this.currentUser = JSON.parse(userJSON);
                    return true;
                } catch (error) {
                    console.error('ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:', error);
                    this.clearAuthAndRedirect();
                    return false;
                }
            }

            setupEventListeners() {
                // ë¡œê³ /íƒ€ì´í‹€ í´ë¦­ ì´ë²¤íŠ¸
                const logoTitle = document.getElementById('logoTitle');
                if (logoTitle) {
                    logoTitle.addEventListener('click', () => {
                        this.navigateToDashboard();
                    });
                }

                // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
                const backButton = document.getElementById('backButton');
                if (backButton) {
                    backButton.addEventListener('click', () => {
                        this.navigateToDashboard();
                    });
                }
            }

            navigateToDashboard() {
                if (this.currentUser.role === 'professor' || this.currentUser.role === 'admin') {
                    this.navigateTo('teacher-dashboard');
                } else {
                    this.navigateTo('dashboard');
                }
            }

            navigateTo(routeName) {
                if (this.routes[routeName]) {
                    this.showLoading();
                    
                    setTimeout(() => {
                        window.location.href = this.routes[routeName];
                    }, 300);
                } else {
                    console.error(`Route not found: ${routeName}`);
                }
            }

            redirectToLogin() {
                this.showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                setTimeout(() => {
                    window.location.href = this.routes.login;
                }, 1500);
            }

            clearAuthAndRedirect() {
                localStorage.clear();
                this.redirectToLogin();
            }

            showLoading() {
                let loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('active');
                }
            }

            hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.remove('active');
                }
            }

            showNotification(message, type = 'success') {
                const existingNotification = document.getElementById('navigationNotification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                const notification = document.createElement('div');
                notification.id = 'navigationNotification';
                notification.className = 'navigation-notification';
                notification.textContent = message;

                const backgroundColor = type === 'error' 
                    ? 'linear-gradient(135deg, #f44336, #d32f2f)' 
                    : 'linear-gradient(135deg, #4CAF50, #45a049)';

                notification.style.background = backgroundColor;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);

                setTimeout(() => {
                    notification.style.transform = 'translateX(400px)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        }

        // ë„¤ë¹„ê²Œì´ì…˜ ë§¤ë‹ˆì € ì´ˆê¸°í™”
        let navigationManager;

        // Blockly ì´ˆê¸°í™” ë° ê¸°ì¡´ ë¸”ë¡ ì½”ë”© ë¡œì§
        document.addEventListener('DOMContentLoaded', function () {
            // ë„¤ë¹„ê²Œì´ì…˜ ë§¤ë‹ˆì € ì´ˆê¸°í™”
            navigationManager = new NavigationManager();

            // ì»¤ìŠ¤í…€ ë¸”ë¡ ì •ì˜
            Blockly.Blocks['start'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField("ì‹œì‘í•˜ê¸°");
                    this.setNextStatement(true, null);
                    this.setColour(240);
                    this.setTooltip("í”„ë¡œê·¸ë¨ì´ ì‹œì‘ë  ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.");
                    this.setHelpUrl("");
                }
            };

            Blockly.Blocks['move_forward'] = {
                init: function () {
                    this.appendValueInput("DISTANCE")
                        .setCheck("Number")
                        .appendField("ì•ìœ¼ë¡œ ì´ë™");
                    this.appendDummyInput()
                        .appendField("ë§Œí¼");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(210);
                    this.setTooltip("ìºë¦­í„°ë¥¼ ì•ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.");
                    this.setHelpUrl("");
                }
            };

            Blockly.Blocks['turn_right'] = {
                init: function () {
                    this.appendValueInput("ANGLE")
                        .setCheck("Number")
                        .appendField("ì˜¤ë¥¸ìª½ìœ¼ë¡œ");
                    this.appendDummyInput()
                        .appendField("ë„");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(210);
                    this.setTooltip("ìºë¦­í„°ë¥¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ íšŒì „ì‹œí‚µë‹ˆë‹¤.");
                    this.setHelpUrl("");
                }
            };

            Blockly.Blocks['turn_left'] = {
                init: function () {
                    this.appendValueInput("ANGLE")
                        .setCheck("Number")
                        .appendField("ì™¼ìª½ìœ¼ë¡œ");
                    this.appendDummyInput()
                        .appendField("ë„");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(210);
                    this.setTooltip("ìºë¦­í„°ë¥¼ ì™¼ìª½ìœ¼ë¡œ íšŒì „ì‹œí‚µë‹ˆë‹¤.");
                    this.setHelpUrl("");
                }
            };

            Blockly.Blocks['wait'] = {
                init: function () {
                    this.appendValueInput("TIME")
                        .setCheck("Number")
                        .appendField("ê¸°ë‹¤ë¦¬ê¸°");
                    this.appendDummyInput()
                        .appendField("ì´ˆ");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(240);
                    this.setTooltip("ì§€ì •ëœ ì‹œê°„(ì´ˆ) ë™ì•ˆ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.");
                    this.setHelpUrl("");
                }
            };

            // JavaScript ì½”ë“œ ìƒì„±ê¸°
            Blockly.JavaScript['start'] = function (block) {
                return '// í”„ë¡œê·¸ë¨ ì‹œì‘\n';
            };

            Blockly.JavaScript['move_forward'] = function (block) {
                var value_distance = Blockly.JavaScript.valueToCode(block, 'DISTANCE', Blockly.JavaScript.ORDER_ATOMIC);
                var code = 'await moveForward(' + value_distance + ');\n';
                return code;
            };

            Blockly.JavaScript['turn_right'] = function (block) {
                var value_angle = Blockly.JavaScript.valueToCode(block, 'ANGLE', Blockly.JavaScript.ORDER_ATOMIC);
                var code = 'await turnRight(' + value_angle + ');\n';
                return code;
            };

            Blockly.JavaScript['turn_left'] = function (block) {
                var value_angle = Blockly.JavaScript.valueToCode(block, 'ANGLE', Blockly.JavaScript.ORDER_ATOMIC);
                var code = 'await turnLeft(' + value_angle + ');\n';
                return code;
            };

            Blockly.JavaScript['wait'] = function (block) {
                var value_time = Blockly.JavaScript.valueToCode(block, 'TIME', Blockly.JavaScript.ORDER_ATOMIC);
                var code = 'await sleep(' + value_time + ');\n';
                return code;
            };

            // JavaScript ë³€ìˆ˜ ê´€ë ¨ ì½”ë“œ ìƒì„±ê¸° ìˆ˜ì •
            Blockly.JavaScript['variables_set'] = function(block) {
                var argument0 = Blockly.JavaScript.valueToCode(block, 'VALUE',
                    Blockly.JavaScript.ORDER_ASSIGNMENT) || '0';
                var varId = block.getFieldValue('VAR');
                var varName = block.workspace.getVariableById(varId).name;
                
                return 'updateVariable("' + varName + '", ' + argument0 + ');\n';
            };

            Blockly.JavaScript['math_change'] = function(block) {
                var argument0 = Blockly.JavaScript.valueToCode(block, 'DELTA',
                    Blockly.JavaScript.ORDER_ADDITION) || '0';
                var varId = block.getFieldValue('VAR');
                var varName = block.workspace.getVariableById(varId).name;
                
                return 'updateVariable("' + varName + '", ' + 
                    'variables["' + varName + '"] + ' + argument0 + ');\n';
            };

            // ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ ìˆ˜ì •
            Blockly.JavaScript['variables_get'] = function(block) {
                var varId = block.getFieldValue('VAR');
                var varName = block.workspace.getVariableById(varId).name;
                
                return ['variables["' + varName + '"]', Blockly.JavaScript.ORDER_ATOMIC];
            };

            // Python ì½”ë“œ ìƒì„±ê¸°ë“¤ë„ ë™ì¼í•˜ê²Œ ìœ ì§€...
            // (ê¸°ì¡´ Python ì½”ë“œ ìƒì„±ê¸°ë“¤ ìƒëµ - ì›ë³¸ê³¼ ë™ì¼)

            // ì‘ì—… ê³µê°„ ì´ˆê¸°í™”
            var workspace = Blockly.inject('blocklyDiv', {
                toolbox: document.getElementById('toolboxXML'),
                grid: {
                    spacing: 20,
                    length: 3,
                    colour: '#ccc',
                    snap: true
                },
                zoom: {
                    controls: true,
                    wheel: true,
                    startScale: 1.0,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                trashcan: true
            });

            // Python ì½”ë“œ ìƒì„±ê¸°
            Blockly.Python['start'] = function (block) {
                return '# í”„ë¡œê·¸ë¨ ì‹œì‘\n';
            };

            Blockly.Python['move_forward'] = function (block) {
                var value_distance = Blockly.Python.valueToCode(block, 'DISTANCE', Blockly.Python.ORDER_ATOMIC);
                var code = 'move_forward(' + value_distance + ')\n';
                return code;
            };

            Blockly.Python['turn_right'] = function (block) {
                var value_angle = Blockly.Python.valueToCode(block, 'ANGLE', Blockly.Python.ORDER_ATOMIC);
                var code = 'turn_right(' + value_angle + ')\n';
                return code;
            };

            Blockly.Python['turn_left'] = function (block) {
                var value_angle = Blockly.Python.valueToCode(block, 'ANGLE', Blockly.Python.ORDER_ATOMIC);
                var code = 'turn_left(' + value_angle + ')\n';
                return code;
            };

            Blockly.Python['wait'] = function (block) {
                var value_time = Blockly.Python.valueToCode(block, 'TIME', Blockly.Python.ORDER_ATOMIC);
                var code = 'wait(' + value_time + ')\n';
                return code;
            };

            // Python ë³€ìˆ˜ ê´€ë ¨ ì½”ë“œ ìƒì„±ê¸°
            Blockly.Python['variables_set'] = function(block) {
                var argument0 = Blockly.Python.valueToCode(block, 'VALUE',
                    Blockly.Python.ORDER_ASSIGNMENT) || '0';
                var varId = block.getFieldValue('VAR');
                var varName = block.workspace.getVariableById(varId).name;
                
                return varName + ' = ' + argument0 + '\n';
            };

            Blockly.Python['variables_get'] = function(block) {
                var varId = block.getFieldValue('VAR');
                var varName = block.workspace.getVariableById(varId).name;
                
                return [varName, Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['math_change'] = function(block) {
                var argument0 = Blockly.Python.valueToCode(block, 'DELTA',
                    Blockly.Python.ORDER_ADDITIVE) || '0';
                var varId = block.getFieldValue('VAR');
                var varName = block.workspace.getVariableById(varId).name;
                
                return varName + ' += ' + argument0 + '\n';
            };

            // ë¸”ë¡ ë³€ê²½ ì´ë²¤íŠ¸ ê°ì§€
            workspace.addChangeListener(function (event) {
                if (event.type == Blockly.Events.BLOCK_CREATE ||
                    event.type == Blockly.Events.BLOCK_DELETE ||
                    event.type == Blockly.Events.BLOCK_CHANGE ||
                    event.type == Blockly.Events.BLOCK_MOVE ||
                    event.type == Blockly.Events.VAR_CREATE ||
                    event.type == Blockly.Events.VAR_DELETE ||
                    event.type == Blockly.Events.VAR_RENAME) {

                    updateCode();
                    updateBlockCount();

                    if (event.type == Blockly.Events.VAR_CREATE ||
                        event.type == Blockly.Events.VAR_RENAME) {
                        let variableList = workspace.getAllVariables();
                        for (let i = 0; i < variableList.length; i++) {
                            let varName = variableList[i].name;
                            if (!(varName in variables)) {
                                updateVariable(varName, 0);
                            }
                        }
                    }
                }
            });

            // ì½”ë“œ ìƒì„± ë° ì—…ë°ì´íŠ¸
            function updateCode() {
                var pythonCode = '';
                
                try {
                    pythonCode = Blockly.Python.workspaceToCode(workspace);
                    
                    var variableList = workspace.getAllVariables();
                    var variableDeclarations = '';
                    
                    if (variableList.length > 0) {
                        variableDeclarations = '# ì „ì—­ ë³€ìˆ˜ ì„ ì–¸\n';
                        if (variableList.length > 0) {
                            variableDeclarations += 'global ' + variableList.map(v => v.name).join(', ') + '\n';
                        }
                    }
                    
                    var formattedPythonCode = '# ìƒì„±ëœ Python ì½”ë“œ\n' +
                        'def main():\n' +
                        (variableDeclarations ? '    ' + variableDeclarations.replace(/\n/g, '\n    ') : '') +
                        '    # í”„ë¡œê·¸ë¨ ì‹œì‘\n' +
                        (variableList.length > 0 ? '    ' + variableList.map(v => v.name + ' = 0').join('\n    ') + '\n' : '') +
                        pythonCode.split('\n').map(line => line ? '    ' + line : '').join('\n') +
                        '\n\n' +
                        'if __name__ == "__main__":\n' +
                        '    main()';
                    
                    pythonCode = formattedPythonCode;
                } catch (e) {
                    console.error('Python ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', e);
                    pythonCode = '# Python ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n# ' + e.message;
                }

                var jsCode = '';
                
                try {
                    jsCode = Blockly.JavaScript.workspaceToCode(workspace);
                    
                    var variableList = workspace.getAllVariables();
                    var variableInitializations = '';
                    
                    for (var i = 0; i < variableList.length; i++) {
                        variableInitializations += ' updateVariable("' + variableList[i].name + '", 0);\n';
                    }
                    
                    jsCode = '// ìƒì„±ëœ JavaScript ì½”ë“œ\n' +
                        'async function main() {\n' +
                        variableInitializations +
                        jsCode.split('\n').map(line => line ? ' ' + line : '').join('\n') +
                        '\n}\n\n' +
                        'main();';
                } catch (e) {
                    console.error('JavaScript ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', e);
                    jsCode = '// JavaScript ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n// ' + e.message;
                }

                var cppCode = generateCppCode(workspace);

                var activeLanguage = document.querySelector('.language-button.active-language').id;
                if (activeLanguage === 'pythonButton') {
                    document.getElementById('codeContent').textContent = pythonCode;
                } else if (activeLanguage === 'javascriptButton') {
                    document.getElementById('codeContent').textContent = jsCode;
                } else if (activeLanguage === 'cppButton') {
                    document.getElementById('codeContent').textContent = cppCode;
                }
            }

            // C++ ì½”ë“œ ìƒì„± í•¨ìˆ˜
            function generateCppCode(workspace) {
                var variableList = workspace.getAllVariables();
                var variableDeclarations = '';
                
                for (var i = 0; i < variableList.length; i++) {
                    variableDeclarations += 'int ' + variableList[i].name + ' = 0;\n';
                }
                
                return '// ìƒì„±ëœ C++ ì½”ë“œ\n' +
                    '#include <iostream>\n' +
                    '#include <chrono>\n' +
                    '#include <thread>\n\n' +
                    variableDeclarations + '\n' +
                    'void move_forward(int distance) {\n' +
                    '    std::cout << "ì•ìœ¼ë¡œ " << distance << "ë§Œí¼ ì´ë™" << std::endl;\n' +
                    '}\n\n' +
                    'void turn_right(int angle) {\n' +
                    '    std::cout << "ì˜¤ë¥¸ìª½ìœ¼ë¡œ " << angle << "ë„ íšŒì „" << std::endl;\n' +
                    '}\n\n' +
                    'void turn_left(int angle) {\n' +
                    '    std::cout << "ì™¼ìª½ìœ¼ë¡œ " << angle << "ë„ íšŒì „" << std::endl;\n' +
                    '}\n\n' +
                    'void wait(int seconds) {\n' +
                    '    std::this_thread::sleep_for(std::chrono::seconds(seconds));\n' +
                    '}\n\n' +
                    'int main() {\n' +
                    '    // ì—¬ê¸°ì— ìƒì„±ëœ ì½”ë“œê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤\n' +
                    '    move_forward(10);\n' +
                    '    for (int i = 0; i < 4; i++) {\n' +
                    '        turn_right(90);\n' +
                    '        move_forward(10);\n' +
                    '    }\n' +
                    '    wait(1);\n' +
                    '    return 0;\n' +
                    '}';
            }

            // ë¸”ë¡ ê°œìˆ˜ ì—…ë°ì´íŠ¸
            function updateBlockCount() {
                var count = workspace.getAllBlocks(false).length;
                document.getElementById('blockCount').textContent = 'ë¸”ë¡ ìˆ˜: ' + count;
            }

            // ê¸°ë³¸ ì½”ë“œ ë¡œë“œ (ìƒ˜í”Œ)
            function loadSampleProgram() {
                var xml = `
<xml xmlns="https://developers.google.com/blockly/xml">
<block type="start" id="start_block" x="300" y="150">
<next>
<block type="variables_set" id="set_score">
<field name="VAR">ì ìˆ˜</field>
<value name="VALUE">
<block type="math_number">
<field name="NUM">0</field>
</block>
</value>
<next>
<block type="move_forward">
<value name="DISTANCE">
<shadow type="math_number">
<field name="NUM">10</field>
</shadow>
</value>
<next>
<block type="controls_repeat_ext">
<value name="TIMES">
<shadow type="math_number">
<field name="NUM">4</field>
</shadow>
</value>
<statement name="DO">
<block type="turn_right">
<value name="ANGLE">
<shadow type="math_number">
<field name="NUM">90</field>
</shadow>
</value>
<next>
<block type="move_forward">
<value name="DISTANCE">
<shadow type="math_number">
<field name="NUM">10</field>
</shadow>
</value>
<next>
<block type="math_change">
<field name="VAR">ì ìˆ˜</field>
<value name="DELTA">
<shadow type="math_number">
<field name="NUM">1</field>
</shadow>
</value>
<next>
<block type="wait">
<value name="TIME">
<shadow type="math_number">
<field name="NUM">1</field>
</shadow>
</value>
</block>
</next>
</block>
</next>
</block>
</next>
</block>
</statement>
</block>
</next>
</block>
</next>
</block>
</next>
</block>
</xml>
`;
                Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(xml), workspace);
                updateCode();
                updateBlockCount();
            }

            // ìºë¦­í„° ìœ„ì¹˜ì™€ ë°©í–¥ ì„¤ì •ì„ ìœ„í•œ ë³€ìˆ˜
            var character = document.getElementById('character');
            var x = 130;
            var y = 130;
            var angle = 0;
            var variables = {};
            var isRunning = false;
            var shouldStop = false;

            // ì½˜ì†”ì— ë©”ì‹œì§€ ì¶”ê°€
            function logToConsole(message) {
                var console = document.getElementById('console');
                var line = document.createElement('div');
                line.className = 'console-line';
                line.textContent = '> ' + message;
                console.appendChild(line);
                console.scrollTop = console.scrollHeight;
            }

            // ë³€ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateVariable(name, value) {
                if (!isNaN(Number(value)) && value !== '') {
                    value = Number(value);
                }
                
                variables[name] = value;
                logToConsole(`ë³€ìˆ˜ ${name}ì˜ ê°’ì´ ${value}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                updateVariableDisplay();
            }

            // ë³€ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸
            function updateVariableDisplay() {
                var variablesDiv = document.getElementById('variables');
                variablesDiv.innerHTML = '';

                for (var name in variables) {
                    var item = document.createElement('div');
                    item.className = 'variable-item';
                    item.textContent = name + ': ' + variables[name];
                    variablesDiv.appendChild(item);
                }

                var posX = document.createElement('div');
                posX.className = 'variable-item';
                posX.textContent = 'ìœ„ì¹˜X: ' + Math.round(x);
                variablesDiv.appendChild(posX);

                var posY = document.createElement('div');
                posY.className = 'variable-item';
                posY.textContent = 'ìœ„ì¹˜Y: ' + Math.round(y);
                variablesDiv.appendChild(posY);
            }

            // ìºë¦­í„° ìƒíƒœ ì´ˆê¸°í™”
            function resetCharacter() {
                x = 130;
                y = 130;
                angle = 0;
                character.style.left = x + 'px';
                character.style.top = y + 'px';
                character.style.transform = 'rotate(' + angle + 'deg)';

                document.getElementById('console').innerHTML = '<div class="console-line">> í”„ë¡œê·¸ë¨ ì‹œì‘</div>';
                variables = {};
                updateVariableDisplay();
            }

            // ì›€ì§ì„ í•¨ìˆ˜
            async function moveForward(distance) {
                logToConsole('ì•ìœ¼ë¡œ ' + distance + 'ë§Œí¼ ì´ë™');

                var radians = angle * Math.PI / 180;
                var targetX = x + Math.sin(radians) * distance;
                var targetY = y - Math.cos(radians) * distance;

                var steps = 20;
                var deltaX = (targetX - x) / steps;
                var deltaY = (targetY - y) / steps;

                for (var i = 0; i < steps; i++) {
                    if (shouldStop) return;
                    x += deltaX;
                    y += deltaY;
                    character.style.left = x + 'px';
                    character.style.top = y + 'px';
                    updateVariableDisplay();
                    await sleep(0.05);
                }

                x = targetX;
                y = targetY;
                character.style.left = x + 'px';
                character.style.top = y + 'px';
                updateVariableDisplay();
            }

            // íšŒì „ í•¨ìˆ˜ (ì˜¤ë¥¸ìª½)
            async function turnRight(degrees) {
                logToConsole('ì˜¤ë¥¸ìª½ìœ¼ë¡œ ' + degrees + 'ë„ íšŒì „');

                var targetAngle = angle + degrees;
                var steps = 10;
                var deltaAngle = degrees / steps;

                for (var i = 0; i < steps; i++) {
                    if (shouldStop) return;
                    angle += deltaAngle;
                    character.style.transform = 'rotate(' + angle + 'deg)';
                    await sleep(0.05);
                }

                angle = targetAngle;
                character.style.transform = 'rotate(' + angle + 'deg)';
            }

            // íšŒì „ í•¨ìˆ˜ (ì™¼ìª½)
            async function turnLeft(degrees) {
                logToConsole('ì™¼ìª½ìœ¼ë¡œ ' + degrees + 'ë„ íšŒì „');

                var targetAngle = angle - degrees;
                var steps = 10;
                var deltaAngle = degrees / steps;

                for (var i = 0; i < steps; i++) {
                    if (shouldStop) return;
                    angle -= deltaAngle;
                    character.style.transform = 'rotate(' + angle + 'deg)';
                    await sleep(0.05);
                }

                angle = targetAngle;
                character.style.transform = 'rotate(' + angle + 'deg)';
            }

            // ì§€ì—° í•¨ìˆ˜
            function sleep(seconds) {
                const ms = seconds * 1000;
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // ì½”ë“œ ì‹¤í–‰ í•¨ìˆ˜
            async function runCode() {
                if (isRunning) return;

                isRunning = true;
                shouldStop = false;
                resetCharacter();
                logToConsole('í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì‹œì‘');

                try {
                    let variableList = workspace.getAllVariables();
                    for (let i = 0; i < variableList.length; i++) {
                        let varName = variableList[i].name;
                        variables[varName] = 0;
                        updateVariableDisplay();
                    }
                    
                    var code = Blockly.JavaScript.workspaceToCode(workspace);
                    
                    code = `async function runUserCode() {
                        try {
                            ${code}
                        } catch (e) {
                            console.error("Error in user code:", e);
                            throw e;
                        }
                    }
                    runUserCode();`;

                    var runFunction = new Function(
                        'moveForward', 'turnRight', 'turnLeft', 
                        'sleep', 'updateVariable', 'variables',
                        code
                    );

                    await runFunction(
                        moveForward, turnRight, turnLeft, 
                        sleep, updateVariable, variables
                    );

                    if (!shouldStop) {
                        logToConsole('í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì™„ë£Œ');
                    }
                } catch (e) {
                    logToConsole('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
                    console.error(e);
                }

                isRunning = false;
            }

            // ì½”ë“œ ì‹¤í–‰ ì¤‘ì§€ í•¨ìˆ˜
            function stopCode() {
                if (!isRunning) return;
                shouldStop = true;
                logToConsole('í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì¤‘ì§€');
            }

            // ì €ì¥ ê¸°ëŠ¥
            function saveProgram() {
                var xml = Blockly.Xml.workspaceToDom(workspace);
                var xmlText = Blockly.Xml.domToText(xml);
                localStorage.setItem('savedProgram', xmlText);

                var now = new Date();
                var timeString = now.getHours().toString().padStart(2, '0') + ':' +
                    now.getMinutes().toString().padStart(2, '0') + ' ' +
                    (now.getHours() >= 12 ? 'PM' : 'AM');
                document.getElementById('lastSaved').textContent = 'ë§ˆì§€ë§‰ ì €ì¥: ' + timeString;

                logToConsole('í”„ë¡œê·¸ë¨ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
                // ë„¤ë¹„ê²Œì´ì…˜ ë§¤ë‹ˆì €ì˜ ì•Œë¦¼ ì‹œìŠ¤í…œ ì‚¬ìš©
                if (navigationManager) {
                    navigationManager.showNotification('í”„ë¡œì íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
            }

            // ë¡œë“œ ê¸°ëŠ¥
            function loadProgram() {
                var savedProgram = localStorage.getItem('savedProgram');
                if (savedProgram) {
                    workspace.clear();
                    var xml = Blockly.Xml.textToDom(savedProgram);
                    Blockly.Xml.domToWorkspace(xml, workspace);
                    updateCode();
                    updateBlockCount();
                    logToConsole('ì €ì¥ëœ í”„ë¡œê·¸ë¨ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                    
                    if (navigationManager) {
                        navigationManager.showNotification('í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                    }
                } else {
                    logToConsole('ì €ì¥ëœ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.');
                    
                    if (navigationManager) {
                        navigationManager.showNotification('ì €ì¥ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    }
                }
            }

            // ì–¸ì–´ ì „í™˜ ê¸°ëŠ¥
            function switchLanguage(language) {
                var pythonButton = document.getElementById('pythonButton');
                var javascriptButton = document.getElementById('javascriptButton');
                var cppButton = document.getElementById('cppButton');
                var codeTitle = document.querySelector('.code-title');

                pythonButton.className = 'language-button inactive-language';
                javascriptButton.className = 'language-button inactive-language';
                cppButton.className = 'language-button inactive-language';

                if (language === 'python') {
                    pythonButton.className = 'language-button active-language';
                    codeTitle.textContent = 'ì‹¤ì œ ì½”ë“œ (Python)';
                    updateCode();
                } else if (language === 'javascript') {
                    javascriptButton.className = 'language-button active-language';
                    codeTitle.textContent = 'ì‹¤ì œ ì½”ë“œ (JavaScript)';
                    updateCode();
                } else if (language === 'cpp') {
                    cppButton.className = 'language-button active-language';
                    codeTitle.textContent = 'ì‹¤ì œ ì½”ë“œ (C++)';
                    updateCode();
                }
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            document.getElementById('runButton').addEventListener('click', runCode);
            document.getElementById('runButtonSmall').addEventListener('click', runCode);
            document.getElementById('stopButton').addEventListener('click', stopCode);
            document.getElementById('resetButton').addEventListener('click', resetCharacter);
            document.getElementById('saveButton').addEventListener('click', saveProgram);
            document.getElementById('loadButton').addEventListener('click', loadProgram);

            // ì–¸ì–´ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('pythonButton').addEventListener('click', function () {
                switchLanguage('python');
            });
            document.getElementById('javascriptButton').addEventListener('click', function () {
                switchLanguage('javascript');
            });
            document.getElementById('cppButton').addEventListener('click', function () {
                switchLanguage('cpp');
            });

            // ìƒ˜í”Œ í”„ë¡œê·¸ë¨ ë¡œë“œ
            loadSampleProgram();

            // ì°½ í¬ê¸° ì¡°ì • ì‹œ Blockly ì¬ì¡°ì •
            window.addEventListener('resize', function () {
                Blockly.svgResize(workspace);
            });

            // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì„¤ì •
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case '1':
                            e.preventDefault();
                            navigationManager.navigateToDashboard();
                            break;
                        case '2':
                            e.preventDefault();
                            // í˜„ì¬ í˜ì´ì§€ì´ë¯€ë¡œ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
                            break;
                        case '3':
                            e.preventDefault();
                            navigationManager.navigateTo('algorithm');
                            break;
                        case '4':
                            e.preventDefault();
                            navigationManager.navigateTo('assignments');
                            break;
                        case '5':
                            e.preventDefault();
                            navigationManager.navigateTo('progress');
                            break;
                        case 's':
                            e.preventDefault();
                            saveProgram();
                            break;
                        case 'o':
                            e.preventDefault();
                            loadProgram();
                            break;
                        case 'r':
                            e.preventDefault();
                            runCode();
                            break;
                    }
                }

                if (e.key === 'Escape') {
                    stopCode();
                }
            });

            // í˜ì´ì§€ ì´íƒˆ ì‹œ í™•ì¸
            window.addEventListener('beforeunload', function (e) {
                if (workspace.getAllBlocks(false).length > 0) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });
    </script>
</body>
</html>