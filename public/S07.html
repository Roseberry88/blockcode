<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>코딩스타트 - 과제 출제</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #4285f4, #2a5298);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            height: 60px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            margin-left: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .logo:hover {
            transform: scale(1.05);
        }
        .profile-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #4285f4;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .profile-icon:hover {
            transform: scale(1.1);
        }
        .sidebar {
            width: 200px;
            background-color: #ffffff;
            padding: 30px 0;
            position: fixed;
            left: 50px;
            top: 80px;
            bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .profile-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 40px;
        }
        .profile-image {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(66, 133, 244, 0.2);
        }
        .teacher-badge {
            background-color: #34a853;
            color: white;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            margin-top: 5px;
        }
        .menu-item {
            padding: 12px 20px;
            margin: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .menu-item.active {
            background-color: #4285f4;
            color: white;
            box-shadow: 0 4px 8px rgba(66, 133, 244, 0.2);
        }
        .menu-item:hover:not(.active) {
            background-color: #f1f8ff;
        }
        .content {
            margin-left: 280px;
            margin-top: 90px;
            padding: 20px;
            width: calc(100% - 320px);
        }
        .page-title {
            font-size: 26px;
            font-weight: bold;
            margin-bottom: 30px;
            color: #333333;
            border-bottom: 2px solid #4285f4;
            padding-bottom: 10px;
            display: inline-block;
        }
        
        /* 폼 스타일 */
        .form-container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .form-section {
            margin-bottom: 25px;
        }
        .form-section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333333;
            display: flex;
            align-items: center;
        }
        .form-section-title i {
            margin-right: 10px;
            font-size: 20px;
            color: #4285f4;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #555555;
        }
        .form-group input[type="text"], 
        .form-group input[type="date"], 
        .form-group input[type="number"], 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #dddddd;
            border-radius: 5px;
            font-size: 14px;
            color: #333333;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        .form-group input[type="text"]:focus, 
        .form-group input[type="date"]:focus, 
        .form-group input[type="number"]:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            border-color: #4285f4;
            outline: none;
        }
        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }
        .form-group select {
            background-color: white;
        }
        .input-hint {
            font-size: 12px;
            color: #888888;
            margin-top: 5px;
        }
        
        /* 토글 스위치 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
            margin-left: 10px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cccccc;
            transition: 0.4s;
            border-radius: 26px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #34a853;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* 과제 유형 선택 카드 */
        .assignment-types {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .type-card {
            flex: 1;
            background-color: white;
            border: 2px solid #dddddd;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .type-card.selected {
            border-color: #4285f4;
            box-shadow: 0 6px 12px rgba(66, 133, 244, 0.15);
        }
        .type-icon {
            font-size: 36px;
            margin-bottom: 15px;
        }
        .type-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .type-description {
            font-size: 12px;
            color: #777777;
        }
        
        /* 채점 기준 */
        .criteria-container {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .criteria-row {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
            padding: 8px;
            border-radius: 5px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .criteria-name {
            flex: 2;
        }
        .criteria-weight {
            flex: 1;
            display: flex;
            align-items: center;
        }
        .criteria-weight input {
            width: 60px;
            padding: 6px;
            border: 1px solid #dddddd;
            border-radius: 3px;
            text-align: center;
        }
        .criteria-weight span {
            margin-left: 5px;
        }
        .criteria-actions {
            width: 30px;
            text-align: center;
            cursor: pointer;
            color: #ff5252;
            font-weight: bold;
        }
        .add-criteria-btn {
            background-color: #f1f3f4;
            padding: 8px 12px;
            border-radius: 5px;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #555555;
            transition: all 0.3s ease;
            margin-top: 5px;
        }
        .add-criteria-btn i {
            margin-right: 8px;
            font-size: 18px;
            color: #4285f4;
        }
        .add-criteria-btn:hover {
            background-color: #e3f2fd;
        }
        
        /* 버튼 스타일 */
        .button-container {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }
        .btn {
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        .btn-primary {
            background-color: #4285f4;
            color: white;
            box-shadow: 0 4px 6px rgba(66, 133, 244, 0.25);
        }
        .btn-primary:hover {
            background-color: #3b78e7;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(66, 133, 244, 0.35);
        }
        .btn-secondary {
            background-color: #f1f3f4;
            color: #333333;
        }
        .btn-secondary:hover {
            background-color: #e4e6e7;
            transform: translateY(-2px);
        }
        
        /* 테스트 케이스 섹션 */
        .test-cases {
            margin-top: 10px;
        }
        .test-case {
            background-color: white;
            border: 1px solid #eeeeee;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .test-case-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 500;
        }
        .test-case-remove {
            color: #ff5252;
            cursor: pointer;
            font-weight: bold;
        }
        .test-case-inputs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .test-case-input, .test-case-output {
            flex: 1;
        }
        .test-case-input textarea, .test-case-output textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #dddddd;
            border-radius: 4px;
            font-size: 14px;
            min-height: 60px;
            resize: vertical;
            box-sizing: border-box;
        }
        .add-test-case-btn {
            display: inline-flex;
            align-items: center;
            background-color: #f1f3f4;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            color: #555555;
            transition: all 0.3s ease;
        }
        .add-test-case-btn:hover {
            background-color: #e3f2fd;
        }
        
        /* 제약사항 체크박스 */
        .constraints-container {
            margin-top: 10px;
        }
        .constraint-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .constraint-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
        }
        .constraint-label {
            flex: 1;
        }
        .constraint-value {
            width: 80px;
        }
        .constraint-value input {
            width: 100%;
            padding: 6px;
            border: 1px solid #dddddd;
            border-radius: 3px;
            text-align: center;
            box-sizing: border-box;
        }

        /* 통합 네비게이션 스타일 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .navigation-notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }

        .error-notification {
            background: linear-gradient(135deg, #f44336, #d32f2f) !important;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4285f4, #34a853);
            width: 0%;
            transition: width 0.3s ease;
        }

        .validation-error {
            color: #f44336;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .form-group.error input,
        .form-group.error textarea,
        .form-group.error select {
            border-color: #f44336;
        }

        .form-group.error .validation-error {
            display: block;
        }
    </style>
</head>
<body>
    <!-- 로딩 오버레이 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="navbar">
            <div class="logo" id="logoLink">🚀 코딩스타트</div>
            <div class="profile-icon" id="profileMenu">
                <span id="userInitial">U</span>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="profile-section">
                <div class="profile-image">
                    <span id="userInitialSidebar">U</span>
                </div>
                <span id="userName">교수님</span>
                <span class="teacher-badge">교수</span>
            </div>
            
            <div class="menu-item" id="dashboardMenu">대시보드</div>
            <div class="menu-item active" id="createAssignmentMenu">과제 출제</div>
            <div class="menu-item" id="reviewSubmissionsMenu">제출물 평가</div>
            <div class="menu-item" id="studentAnalyticsMenu">학생 성취도</div>
            <div class="menu-item" id="managementMenu">학생 관리</div>
        </div>
        
        <div class="content">
            <h1 class="page-title">📋 과제 출제</h1>
            
            <div class="form-container">
                <form id="createAssignmentForm">
                    <div class="form-section">
                        <div class="form-section-title">
                            <i>📝</i> 기본 정보
                        </div>
                        
                        <div class="form-group">
                            <label for="assignmentTitle">과제명 *</label>
                            <input type="text" id="assignmentTitle" name="assignmentTitle" placeholder="예: 반복문으로 사각형 그리기" required>
                            <div class="validation-error">과제명을 입력해주세요.</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="assignmentDescription">과제 설명 *</label>
                            <textarea id="assignmentDescription" name="assignmentDescription" placeholder="과제에 대한 상세한 설명을 작성하세요..." required></textarea>
                            <div class="validation-error">과제 설명을 입력해주세요.</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="problemStatement">문제 명세 *</label>
                            <textarea id="problemStatement" name="problemStatement" placeholder="학생들이 해결해야 할 구체적인 문제를 작성하세요..." required></textarea>
                            <div class="validation-error">문제 명세를 입력해주세요.</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="difficultyLevel">난이도 *</label>
                            <select id="difficultyLevel" name="difficultyLevel" required>
                                <option value="">난이도 선택</option>
                                <option value="easy">초급 (Easy)</option>
                                <option value="medium">중급 (Medium)</option>
                                <option value="hard">고급 (Hard)</option>
                            </select>
                            <div class="validation-error">난이도를 선택해주세요.</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i>📅</i> 일정 설정
                        </div>
                        
                        <div class="form-group">
                            <label for="dueDate">마감일 *</label>
                            <input type="date" id="dueDate" name="dueDate" required>
                            <div class="validation-error">마감일을 설정해주세요.</div>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                과제 활성화
                                <label class="toggle-switch">
                                    <input type="checkbox" id="isActive" name="isActive" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </label>
                            <div class="input-hint">비활성화 시 학생들에게 과제가 보이지 않습니다.</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i>🧪</i> 테스트 케이스
                        </div>
                        
                        <div class="test-cases" id="testCasesContainer">
                            <div class="test-case">
                                <div class="test-case-header">
                                    <div>테스트 케이스 #1</div>
                                    <div class="test-case-remove">✕</div>
                                </div>
                                <div class="test-case-inputs">
                                    <div class="test-case-input">
                                        <label>입력 데이터</label>
                                        <textarea placeholder="테스트 입력값을 입력하세요..." name="testInput"></textarea>
                                    </div>
                                    <div class="test-case-output">
                                        <label>예상 출력</label>
                                        <textarea placeholder="예상 출력값을 입력하세요..." name="testOutput"></textarea>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" name="testHidden" style="margin-right: 8px;">
                                        숨겨진 테스트 케이스 (학생에게 보이지 않음)
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="add-test-case-btn" id="addTestCaseBtn">
                            <i>+</i> 테스트 케이스 추가
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i>⚖️</i> 채점 기준
                        </div>
                        
                        <div class="form-group">
                            <label for="gradingCriteria">채점 기준 (JSON 형식)</label>
                            <textarea id="gradingCriteria" name="gradingCriteria" placeholder='{"accuracy": 60, "code_quality": 25, "efficiency": 15}' style="min-height: 100px;"></textarea>
                            <div class="input-hint">채점 기준을 JSON 형식으로 입력하세요. 예: {"정확성": 60, "코드품질": 25, "효율성": 15}</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i>💾</i> 저장 및 미리보기
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        
                        <div class="button-container">
                            <button type="button" class="btn btn-secondary" id="saveDraftBtn">임시 저장</button>
                            <button type="button" class="btn btn-secondary" id="previewBtn">미리보기</button>
                            <button type="submit" class="btn btn-primary">과제 생성</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // 통합 네비게이션 시스템
        class NavigationManager {
            constructor() {
                this.currentUser = null;
                this.routes = {
                    'dashboard': '/dashboard',
                    'teacher-dashboard': '/teacher-dashboard',
                    'create-assignment': '/create-assignment',
                    'review-submissions': '/review-submissions',
                    'student-analytics': '/student-analytics',
                    'student-management': '/student-management',
                    'block-coding': '/block-coding',
                    'algorithm': '/algorithm',
                    'assignments': '/assignments',
                    'progress': '/progress',
                    'login': '/login'
                };
                
                this.init();
            }

            init() {
                if (!this.loadUserInfo()) return;
                this.updateNavigationUI();
                this.setupEventListeners();
            }

            loadUserInfo() {
                const token = localStorage.getItem('authToken');
                const userJSON = localStorage.getItem('user');

                if (!token || !userJSON) {
                    this.redirectToLogin();
                    return false;
                }

                try {
                    this.currentUser = JSON.parse(userJSON);
                    
                    // 교수/관리자 권한 확인
                    if (this.currentUser.role !== 'professor' && this.currentUser.role !== 'admin') {
                        this.showNotification('교수 권한이 필요합니다.', 'error');
                        setTimeout(() => {
                            this.navigateTo('dashboard');
                        }, 1500);
                        return false;
                    }
                    
                    return true;
                } catch (error) {
                    console.error('사용자 정보 파싱 오류:', error);
                    this.clearAuthAndRedirect();
                    return false;
                }
            }

            updateNavigationUI() {
                if (!this.currentUser) return;

                // 사용자 이름 업데이트
                const userNameEl = document.getElementById('userName');
                if (userNameEl) {
                    userNameEl.textContent = this.currentUser.name || '교수님';
                }

                // 사용자 이니셜 업데이트
                const initial = (this.currentUser.name || 'U').charAt(0).toUpperCase();
                const initialElements = document.querySelectorAll('#userInitial, #userInitialSidebar');
                initialElements.forEach(el => {
                    if (el) el.textContent = initial;
                });
            }

            setupEventListeners() {
                // 로고 클릭 이벤트
                const logoLink = document.getElementById('logoLink');
                if (logoLink) {
                    logoLink.addEventListener('click', () => {
                        this.navigateTo('teacher-dashboard');
                    });
                }

                // 프로필 메뉴 클릭 이벤트
                const profileMenu = document.getElementById('profileMenu');
                if (profileMenu) {
                    profileMenu.addEventListener('click', () => {
                        this.handleLogout();
                    });
                }

                // 사이드바 메뉴 이벤트
                const menuMappings = {
                    'dashboardMenu': () => this.navigateTo('teacher-dashboard'),
                    'createAssignmentMenu': () => this.navigateTo('create-assignment'),
                    'reviewSubmissionsMenu': () => this.navigateTo('review-submissions'),
                    'studentAnalyticsMenu': () => this.navigateTo('student-analytics'),
                    'managementMenu': () => this.navigateTo('student-management')
                };

                Object.keys(menuMappings).forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('click', (e) => {
                            e.preventDefault();
                            menuMappings[id]();
                        });
                    }
                });
            }

            navigateTo(routeName) {
                if (this.routes[routeName]) {
                    this.showLoading();
                    
                    setTimeout(() => {
                        window.location.href = this.routes[routeName];
                    }, 300);
                } else {
                    console.error(`Route not found: ${routeName}`);
                }
            }

            redirectToLogin() {
                this.showNotification('로그인이 필요합니다.', 'error');
                setTimeout(() => {
                    window.location.href = this.routes.login;
                }, 1500);
            }

            clearAuthAndRedirect() {
                localStorage.clear();
                this.redirectToLogin();
            }

            handleLogout() {
                if (confirm('로그아웃 하시겠습니까?')) {
                    this.showLoading();
                    
                    const token = localStorage.getItem('authToken');
                    fetch('/api/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token,
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(() => {
                        localStorage.clear();
                        this.showNotification('로그아웃되었습니다.');
                        setTimeout(() => {
                            window.location.href = this.routes.login;
                        }, 1000);
                    })
                    .catch((error) => {
                        console.error('로그아웃 오류:', error);
                        localStorage.clear();
                        window.location.href = this.routes.login;
                    })
                    .finally(() => {
                        this.hideLoading();
                    });
                }
            }

            showLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('active');
                }
            }

            hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.remove('active');
                }
            }

            showNotification(message, type = 'success') {
                const existingNotification = document.getElementById('navigationNotification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                const notification = document.createElement('div');
                notification.id = 'navigationNotification';
                notification.className = `navigation-notification ${type === 'error' ? 'error-notification' : ''}`;
                notification.textContent = message;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);

                setTimeout(() => {
                    notification.style.transform = 'translateX(400px)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        }

        // 과제 생성 관리자 클래스
        class AssignmentCreator {
            constructor() {
                this.testCaseCount = 1;
                this.isDraft = false;
                this.currentData = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setDefaultValues();
                this.loadDraftIfExists();
            }

            setupEventListeners() {
                // 폼 제출 이벤트
                document.getElementById('createAssignmentForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSubmit(false); // 실제 생성
                });

                // 임시 저장 버튼
                document.getElementById('saveDraftBtn').addEventListener('click', () => {
                    this.handleSubmit(true); // 임시 저장
                });

                // 미리보기 버튼
                document.getElementById('previewBtn').addEventListener('click', () => {
                    this.showPreview();
                });

                // 테스트 케이스 추가 버튼
                document.getElementById('addTestCaseBtn').addEventListener('click', () => {
                    this.addTestCase();
                });

                // 기존 테스트 케이스 삭제 이벤트
                this.setupTestCaseRemoveEvents();

                // 실시간 유효성 검사
                this.setupRealTimeValidation();

                // 키보드 단축키
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 's':
                                e.preventDefault();
                                this.handleSubmit(true); // 임시 저장
                                break;
                            case 'Enter':
                                if (e.shiftKey) {
                                    e.preventDefault();
                                    this.handleSubmit(false); // 실제 생성
                                }
                                break;
                        }
                    }
                });

                // 폼 변경 감지 (진행률 업데이트)
                const formElements = document.querySelectorAll('#createAssignmentForm input, #createAssignmentForm textarea, #createAssignmentForm select');
                formElements.forEach(element => {
                    element.addEventListener('input', () => {
                        this.updateProgress();
                    });
                });
            }

            setDefaultValues() {
                // 오늘부터 2주 후를 기본 마감일로 설정
                const today = new Date();
                const dueDate = new Date();
                dueDate.setDate(today.getDate() + 14);
                document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];

                // 기본 채점 기준 설정
                const defaultCriteria = {
                    "정확성": 50,
                    "코드 구조": 30,
                    "효율성": 20
                };
                document.getElementById('gradingCriteria').value = JSON.stringify(defaultCriteria, null, 2);

                this.updateProgress();
            }

            setupTestCaseRemoveEvents() {
                document.querySelectorAll('.test-case-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const testCase = e.target.closest('.test-case');
                        const container = document.getElementById('testCasesContainer');
                        
                        // 최소 1개의 테스트 케이스는 유지
                        if (container.querySelectorAll('.test-case').length > 1) {
                            testCase.remove();
                            this.updateTestCaseNumbers();
                            this.updateProgress();
                        } else {
                            navigationManager.showNotification('최소 1개의 테스트 케이스가 필요합니다.', 'error');
                        }
                    });
                });
            }

            addTestCase() {
                this.testCaseCount++;
                const container = document.getElementById('testCasesContainer');
                
                const newTestCase = document.createElement('div');
                newTestCase.className = 'test-case';
                newTestCase.innerHTML = `
                    <div class="test-case-header">
                        <div>테스트 케이스 #${this.testCaseCount}</div>
                        <div class="test-case-remove">✕</div>
                    </div>
                    <div class="test-case-inputs">
                        <div class="test-case-input">
                            <label>입력 데이터</label>
                            <textarea placeholder="테스트 입력값을 입력하세요..." name="testInput"></textarea>
                        </div>
                        <div class="test-case-output">
                            <label>예상 출력</label>
                            <textarea placeholder="예상 출력값을 입력하세요..." name="testOutput"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="testHidden" style="margin-right: 8px;">
                            숨겨진 테스트 케이스 (학생에게 보이지 않음)
                        </label>
                    </div>
                `;
                
                container.appendChild(newTestCase);
                
                // 새로운 테스트 케이스의 삭제 이벤트 추가
                newTestCase.querySelector('.test-case-remove').addEventListener('click', (e) => {
                    const testCase = e.target.closest('.test-case');
                    const container = document.getElementById('testCasesContainer');
                    
                    if (container.querySelectorAll('.test-case').length > 1) {
                        testCase.remove();
                        this.updateTestCaseNumbers();
                        this.updateProgress();
                    } else {
                        navigationManager.showNotification('최소 1개의 테스트 케이스가 필요합니다.', 'error');
                    }
                });

                // 새로운 입력 필드에 이벤트 리스너 추가
                newTestCase.querySelectorAll('textarea').forEach(textarea => {
                    textarea.addEventListener('input', () => {
                        this.updateProgress();
                    });
                });

                this.updateProgress();
                navigationManager.showNotification('테스트 케이스가 추가되었습니다.');
            }

            updateTestCaseNumbers() {
                const testCases = document.querySelectorAll('.test-case');
                testCases.forEach((testCase, index) => {
                    testCase.querySelector('.test-case-header div:first-child').textContent = `테스트 케이스 #${index + 1}`;
                });
                this.testCaseCount = testCases.length;
            }

            setupRealTimeValidation() {
                const requiredFields = [
                    { id: 'assignmentTitle', message: '과제명을 입력해주세요.' },
                    { id: 'assignmentDescription', message: '과제 설명을 입력해주세요.' },
                    { id: 'problemStatement', message: '문제 명세를 입력해주세요.' },
                    { id: 'difficultyLevel', message: '난이도를 선택해주세요.' },
                    { id: 'dueDate', message: '마감일을 설정해주세요.' }
                ];

                requiredFields.forEach(field => {
                    const element = document.getElementById(field.id);
                    const formGroup = element.closest('.form-group');
                    
                    element.addEventListener('blur', () => {
                        this.validateField(element, formGroup, field.message);
                    });

                    element.addEventListener('input', () => {
                        if (formGroup.classList.contains('error')) {
                            this.validateField(element, formGroup, field.message);
                        }
                    });
                });

                // 채점 기준 JSON 유효성 검사
                const gradingCriteria = document.getElementById('gradingCriteria');
                gradingCriteria.addEventListener('blur', () => {
                    this.validateGradingCriteria();
                });
            }

            validateField(element, formGroup, message) {
                const isValid = element.value.trim() !== '';
                
                if (isValid) {
                    formGroup.classList.remove('error');
                } else {
                    formGroup.classList.add('error');
                    formGroup.querySelector('.validation-error').textContent = message;
                }
                
                return isValid;
            }

            validateGradingCriteria() {
                const element = document.getElementById('gradingCriteria');
                const formGroup = element.closest('.form-group');
                
                try {
                    if (element.value.trim()) {
                        const criteria = JSON.parse(element.value);
                        if (typeof criteria === 'object' && criteria !== null) {
                            formGroup.classList.remove('error');
                            return true;
                        }
                    }
                } catch (e) {
                    formGroup.classList.add('error');
                    formGroup.querySelector('.validation-error').textContent = '올바른 JSON 형식이 아닙니다.';
                    return false;
                }
                
                return true; // 빈 값은 허용
            }

            updateProgress() {
                const requiredFields = [
                    'assignmentTitle',
                    'assignmentDescription', 
                    'problemStatement',
                    'difficultyLevel',
                    'dueDate'
                ];

                let completedFields = 0;

                // 필수 필드 확인
                requiredFields.forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element && element.value.trim()) {
                        completedFields++;
                    }
                });

                // 테스트 케이스 확인
                const testCases = document.querySelectorAll('.test-case');
                let hasValidTestCase = false;
                testCases.forEach(testCase => {
                    const input = testCase.querySelector('textarea[name="testInput"]').value.trim();
                    const output = testCase.querySelector('textarea[name="testOutput"]').value.trim();
                    if (input && output) {
                        hasValidTestCase = true;
                    }
                });

                if (hasValidTestCase) {
                    completedFields++;
                }

                const totalFields = requiredFields.length + 1; // +1 for test cases
                const progress = Math.round((completedFields / totalFields) * 100);
                
                document.getElementById('progressFill').style.width = progress + '%';
            }

            collectFormData() {
                const formData = {
                    title: document.getElementById('assignmentTitle').value.trim(),
                    description: document.getElementById('assignmentDescription').value.trim(),
                    problem_statement: document.getElementById('problemStatement').value.trim(),
                    difficulty_level: document.getElementById('difficultyLevel').value,
                    due_date: document.getElementById('dueDate').value,
                    is_active: document.getElementById('isActive').checked,
                    grading_criteria: null,
                    test_cases: []
                };

                // 채점 기준 처리
                const gradingCriteriaText = document.getElementById('gradingCriteria').value.trim();
                if (gradingCriteriaText) {
                    try {
                        formData.grading_criteria = JSON.parse(gradingCriteriaText);
                    } catch (e) {
                        throw new Error('채점 기준 JSON 형식이 올바르지 않습니다.');
                    }
                }

                // 테스트 케이스 수집
                const testCases = document.querySelectorAll('.test-case');
                testCases.forEach((testCase, index) => {
                    const input = testCase.querySelector('textarea[name="testInput"]').value.trim();
                    const output = testCase.querySelector('textarea[name="testOutput"]').value.trim();
                    const isHidden = testCase.querySelector('input[name="testHidden"]').checked;

                    if (input && output) {
                        formData.test_cases.push({
                            input_data: input,
                            expected_output: output,
                            description: `테스트 케이스 ${index + 1}`,
                            is_hidden: isHidden
                        });
                    }
                });

                return formData;
            }

            validateFormData(data) {
                const errors = [];

                if (!data.title) errors.push('과제명을 입력해주세요.');
                if (!data.description) errors.push('과제 설명을 입력해주세요.');
                if (!data.problem_statement) errors.push('문제 명세를 입력해주세요.');
                if (!data.difficulty_level) errors.push('난이도를 선택해주세요.');
                if (!data.due_date) errors.push('마감일을 설정해주세요.');

                // 마감일 유효성 검사
                const dueDate = new Date(data.due_date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (dueDate < today) {
                    errors.push('마감일은 오늘 이후로 설정해야 합니다.');
                }

                // 테스트 케이스 검사
                if (data.test_cases.length === 0) {
                    errors.push('최소 1개의 유효한 테스트 케이스가 필요합니다.');
                }

                return errors;
            }

            async handleSubmit(isDraft = false) {
                try {
                    const data = this.collectFormData();
                    
                    if (!isDraft) {
                        const errors = this.validateFormData(data);
                        if (errors.length > 0) {
                            navigationManager.showNotification(errors[0], 'error');
                            return;
                        }
                    }

                    this.isDraft = isDraft;
                    
                    if (isDraft) {
                        await this.saveDraft(data);
                    } else {
                        await this.createAssignment(data);
                    }

                } catch (error) {
                    console.error('폼 처리 오류:', error);
                    navigationManager.showNotification(error.message || '오류가 발생했습니다.', 'error');
                }
            }

            async saveDraft(data) {
                try {
                    localStorage.setItem('assignmentDraft', JSON.stringify(data));
                    navigationManager.showNotification('임시 저장되었습니다.');
                } catch (error) {
                    navigationManager.showNotification('임시 저장 중 오류가 발생했습니다.', 'error');
                }
            }

            loadDraftIfExists() {
                try {
                    const draftData = localStorage.getItem('assignmentDraft');
                    if (draftData) {
                        const data = JSON.parse(draftData);
                        this.populateForm(data);
                        navigationManager.showNotification('임시 저장된 데이터를 불러왔습니다.');
                    }
                } catch (error) {
                    console.error('임시 저장 데이터 로드 오류:', error);
                }
            }

            populateForm(data) {
                if (data.title) document.getElementById('assignmentTitle').value = data.title;
                if (data.description) document.getElementById('assignmentDescription').value = data.description;
                if (data.problem_statement) document.getElementById('problemStatement').value = data.problem_statement;
                if (data.difficulty_level) document.getElementById('difficultyLevel').value = data.difficulty_level;
                if (data.due_date) document.getElementById('dueDate').value = data.due_date;
                if (typeof data.is_active !== 'undefined') document.getElementById('isActive').checked = data.is_active;
                
                if (data.grading_criteria) {
                    document.getElementById('gradingCriteria').value = JSON.stringify(data.grading_criteria, null, 2);
                }

                // 테스트 케이스 복원
                if (data.test_cases && data.test_cases.length > 0) {
                    const container = document.getElementById('testCasesContainer');
                    container.innerHTML = ''; // 기존 테스트 케이스 제거

                    data.test_cases.forEach((testCase, index) => {
                        this.addTestCaseWithData(testCase, index + 1);
                    });
                }

                this.updateProgress();
            }

            addTestCaseWithData(testCase, number) {
                const container = document.getElementById('testCasesContainer');
                
                const newTestCase = document.createElement('div');
                newTestCase.className = 'test-case';
                newTestCase.innerHTML = `
                    <div class="test-case-header">
                        <div>테스트 케이스 #${number}</div>
                        <div class="test-case-remove">✕</div>
                    </div>
                    <div class="test-case-inputs">
                        <div class="test-case-input">
                            <label>입력 데이터</label>
                            <textarea placeholder="테스트 입력값을 입력하세요..." name="testInput">${testCase.input_data || ''}</textarea>
                        </div>
                        <div class="test-case-output">
                            <label>예상 출력</label>
                            <textarea placeholder="예상 출력값을 입력하세요..." name="testOutput">${testCase.expected_output || ''}</textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="testHidden" style="margin-right: 8px;" ${testCase.is_hidden ? 'checked' : ''}>
                            숨겨진 테스트 케이스 (학생에게 보이지 않음)
                        </label>
                    </div>
                `;
                
                container.appendChild(newTestCase);
                
                // 이벤트 리스너 추가
                newTestCase.querySelector('.test-case-remove').addEventListener('click', (e) => {
                    const testCase = e.target.closest('.test-case');
                    const container = document.getElementById('testCasesContainer');
                    
                    if (container.querySelectorAll('.test-case').length > 1) {
                        testCase.remove();
                        this.updateTestCaseNumbers();
                        this.updateProgress();
                    } else {
                        navigationManager.showNotification('최소 1개의 테스트 케이스가 필요합니다.', 'error');
                    }
                });

                newTestCase.querySelectorAll('textarea').forEach(textarea => {
                    textarea.addEventListener('input', () => {
                        this.updateProgress();
                    });
                });

                this.testCaseCount = Math.max(this.testCaseCount, number);
            }

            async createAssignment(data) {
                navigationManager.showLoading();

                const token = localStorage.getItem('authToken');
                
                try {
                    const response = await fetch('/api/assignments', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        // 임시 저장 데이터 삭제
                        localStorage.removeItem('assignmentDraft');
                        
                        navigationManager.showNotification('과제가 성공적으로 생성되었습니다!');
                        
                        // 2초 후 대시보드로 이동
                        setTimeout(() => {
                            navigationManager.navigateTo('teacher-dashboard');
                        }, 2000);
                    } else {
                        throw new Error(result.message || '과제 생성에 실패했습니다.');
                    }
                } catch (error) {
                    console.error('과제 생성 오류:', error);
                    navigationManager.showNotification(
                        error.message || '과제 생성 중 오류가 발생했습니다.', 
                        'error'
                    );
                } finally {
                    navigationManager.hideLoading();
                }
            }

            showPreview() {
                try {
                    const data = this.collectFormData();
                    
                    // 미리보기 윈도우 생성
                    const previewWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
                    
                    const previewHTML = `
                        <!DOCTYPE html>
                        <html lang="ko">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>과제 미리보기</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                                .header { background: #4285f4; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                                .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
                                .test-case { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; }
                                .difficulty { padding: 4px 8px; border-radius: 4px; color: white; font-size: 12px; }
                                .easy { background: #34a853; }
                                .medium { background: #fbbc05; }
                                .hard { background: #ea4335; }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>${data.title || '과제 제목'}</h1>
                                <p>난이도: <span class="difficulty ${data.difficulty_level}">${this.getDifficultyText(data.difficulty_level)}</span></p>
                                <p>마감일: ${data.due_date || '미설정'}</p>
                            </div>
                            
                            <div class="section">
                                <h2>📝 과제 설명</h2>
                                <p>${data.description || '설명이 입력되지 않았습니다.'}</p>
                            </div>
                            
                            <div class="section">
                                <h2>📋 문제 명세</h2>
                                <p>${data.problem_statement || '문제 명세가 입력되지 않았습니다.'}</p>
                            </div>
                            
                            ${data.test_cases.length > 0 ? `
                            <div class="section">
                                <h2>🧪 테스트 케이스</h2>
                                ${data.test_cases.map((testCase, index) => `
                                    <div class="test-case">
                                        <h4>테스트 케이스 ${index + 1} ${testCase.is_hidden ? '(숨김)' : ''}</h4>
                                        <p><strong>입력:</strong><br><pre>${testCase.input_data}</pre></p>
                                        <p><strong>예상 출력:</strong><br><pre>${testCase.expected_output}</pre></p>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                            
                            ${data.grading_criteria ? `
                            <div class="section">
                                <h2>⚖️ 채점 기준</h2>
                                <pre>${JSON.stringify(data.grading_criteria, null, 2)}</pre>
                            </div>
                            ` : ''}
                        </body>
                        </html>
                    `;
                    
                    previewWindow.document.write(previewHTML);
                    previewWindow.document.close();
                    
                } catch (error) {
                    navigationManager.showNotification('미리보기 생성 중 오류가 발생했습니다.', 'error');
                }
            }

            getDifficultyText(level) {
                const levels = {
                    'easy': '초급 (Easy)',
                    'medium': '중급 (Medium)', 
                    'hard': '고급 (Hard)'
                };
                return levels[level] || level;
            }
        }

        // 네비게이션 매니저 및 과제 생성자 초기화
        let navigationManager;
        let assignmentCreator;

        document.addEventListener('DOMContentLoaded', function() {
            // 네비게이션 매니저 초기화
            navigationManager = new NavigationManager();
            
            // 과제 생성자 초기화
            assignmentCreator = new AssignmentCreator();
            
            // 로딩 종료
            if (navigationManager) {
                navigationManager.hideLoading();
            }
        });
    </script>
</body>
</html>